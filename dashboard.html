<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Simple Range Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            /* Primary brand colours – modern teal/amber on dark background */
            --primary-green: #0d9488;
            --secondary-green: #14b8a6;
            --accent-orange: #f59e0b;
            --light-green: #5eead4;
            --dark-green: #134e4a;

            /* Surfaces & text – dark mode baseline */
            --background: #0f172a;
            --surface: #1e293b;
            --surface-variant: #334155;
            --on-surface: #f1f5f9;
            --on-surface-variant: #cbd5e1;
            --outline: #475569;
            --off: #ef4444;

            /* Shadows */
            --shadow: rgba(0,0,0,0.25);
            --shadow-strong: rgba(0,0,0,0.5);

            /* Radii */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        /* Improved hole marker styling for course creation */
        .hole-marker {
            background: var(--primary-green);
            border: 3px solid white;
            border-radius: 50%;
            color: white;
            width: 32px !important;
            height: 32px !important;
            line-height: 28px !important;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            cursor: grab;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .hole-marker:hover {
            transform: scale(1.2);
            background: var(--secondary-green);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        body {
            background: var(--background);
            color: var(--on-surface);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            transition: all 0.2s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .card h2 {
            margin-bottom: 1rem;
            color: var(--on-surface);
            border-bottom: 2px solid #e8f5e8;
            padding-bottom: 0.5rem;
        }

        .btn {
            background: var(--secondary-green);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: var(--primary-green);
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-secondary {
            background: var(--surface-variant);
            color: var(--on-surface);
        }

        .btn-secondary:hover {
            background: var(--outline);
        }

        .course-list {
            list-style: none;
        }

        .course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background 0.2s;
            background-color: var(--surface-variant);
        }

        .course-item:hover {
            background: var(--surface);
        }

        .course-info h3 {
            margin: 0;
            color: var(--on-surface);
        }

        .course-meta {
            font-size: 0.875rem;
            color: var(--on-surface-variant);
            margin-top: 0.25rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-approved {
            background: #2e7d32;
            color: #e8f5e8;
        }

        .status-pending {
            background: #f57c00;
            color: #fff3e0;
        }

        .status-private {
            background: #1976d2;
            color: #e3f2fd;
        }

        .course-actions {
            display: flex;
            gap: 0.5rem;
        }

        .course-actions button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: #2e7d32;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4caf50;
        }

        .map-container {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .hole-creator {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .hole-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.5rem;
        }

        .hole-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .hole-item:last-child {
            border-bottom: none;
        }

        .error {
            color: #d32f2f;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 2rem;
        }

        .welcome-message {
            background: var(--surface-variant);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .course-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .course-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>Simple Range Finder - Dashboard</h1>
            <nav class="nav-links">
                <a href="index.html">← Back to App</a>
                <a href="#" id="logoutBtn">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="welcome-message">
            <h2>Welcome, <span id="userEmail"></span>!</h2>
            <p>Manage your golf courses and view course statistics.</p>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>Your Courses</h2>
                <div id="userCourses">
                    <div class="loading">Loading your courses...</div>
                </div>
                <button class="btn" id="createCourseBtn">Create New Course</button>
            </div>

            <div class="card" id="adminPanel" style="display: none;">
                <h2>Manage All Courses</h2>
                <div id="allCourses">
                    <div class="loading">Loading courses...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Create/Edit Course Modal -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <h2 id="courseModalTitle">Create New Course</h2>
            <form id="courseForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="courseName">Course Name:</label>
                        <input type="text" id="courseName" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Course Location (click to set center):</label>
                    <div id="courseMap" class="map-container"></div>
                </div>

                <div class="hole-creator">
                    <h3>Add Holes</h3>
                    <p>Click on the map to place holes. You can drag markers to adjust positions.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="currentHole">Hole Number:</label>
                            <input type="number" id="currentHole" min="1" max="18" value="1">
                        </div>
                        <div class="form-group">
                            <label for="holePar">Par:</label>
                            <select id="holePar">
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="addHoleBtn">Add Hole</button>
                    <p style="margin-top: 0.75rem; font-size: 0.875rem; color: #666;">
                        <strong>Tip:</strong> After adding a hole, you can drag its marker to adjust the position precisely.
                        The markers are clearly visible with a white border and will show the hole number.
                    </p>
                </div>

                <div class="form-group">
                    <label>Current Holes:</label>
                    <div id="holesList" class="hole-list">
                        <div class="empty-state">No holes added yet</div>
                    </div>
                </div>

                <div class="error" id="courseError"></div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn" id="saveCourseBtn">Save Course</button>
                    <button type="button" class="btn btn-secondary" id="cancelCourseBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ijyosisdbancyaanpdrg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqeW9zaXNkYmFuY3lhYW5wZHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTI0NTMsImV4cCI6MjA3MjU2ODQ1M30.YjZ3H1OynYfvbeABLut0tSS18mY3CLITTrUeA9wrpIg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App state
        let currentUser = null;
        let isAdmin = false;
        let editingCourse = null;
        let courseMap = null;
        let courseHoles = [];
        let courseCenter = [33.7490, -84.3880]; // Default to Atlanta

        // DOM elements
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const createCourseBtn = document.getElementById('createCourseBtn');
        const courseModal = document.getElementById('courseModal');
        const courseForm = document.getElementById('courseForm');
        const courseModalTitle = document.getElementById('courseModalTitle');
        const saveCourseBtn = document.getElementById('saveCourseBtn');
        const cancelCourseBtn = document.getElementById('cancelCourseBtn');
        const addHoleBtn = document.getElementById('addHoleBtn');
        const courseError = document.getElementById('courseError');

        // Initialize dashboard
        async function initializeDashboard() {
            // Check authentication
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = session.user;
            userEmail.textContent = currentUser.email;

            // Check if user is admin
            try {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('role')
                    .eq('id', currentUser.id)
                    .single();
                
                isAdmin = profile?.role === 'admin';
                if (isAdmin) {
                    document.getElementById('adminPanel').style.display = 'block';
                    // CHANGED: Call the new function to load all courses
                    await loadAllCoursesForAdmin();
                }
            } catch (error) {
                console.log('Profile not found or not admin:', error);
            }

            await loadUserCourses();
            setupEventListeners();
        }

        async function loadUserCourses() {
            try {
                const { data, error } = await supabaseClient
                    .from('courses')
                    .select(`
                        *,
                        holes (*)
                    `)
                    .eq('created_by', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayUserCourses(data);
            } catch (error) {
                console.error('Error loading user courses:', error);
                document.getElementById('userCourses').innerHTML = 
                    '<div class="error">Error loading your courses</div>';
            }
        }
        
        // CHANGED: Renamed function and updated query to fetch ALL courses for the admin
        async function loadAllCoursesForAdmin() {
            if (!isAdmin) return;

            try {
                // CHANGED: Call the new RPC function instead of .from('courses').select()
                const { data, error } = await supabaseClient
                    .rpc('get_all_courses_for_admin');

                if (error) throw error;

                displayAllCoursesForAdmin(data);

            } catch (error) {
                console.error('Error loading all courses for admin:', error);
                document.getElementById('allCourses').innerHTML = 
                    '<div class="error">Error loading courses</div>';
            }
        }


        function displayUserCourses(courses) {
            const container = document.getElementById('userCourses');
            
            if (!courses || courses.length === 0) {
                container.innerHTML = '<div class="empty-state">You haven\'t created any courses yet</div>';
                return;
            }

            container.innerHTML = `
                <ul class="course-list">
                    ${courses.map(course => {
                        // --- CHANGE START ---
                        // Dynamically create action buttons
                        let actions = `
                            <button class="btn btn-secondary" onclick="editCourse('${course.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteCourse('${course.id}')">Delete</button>
                        `;

                        // If user is an admin and the course is pending, add the Approve button
                        if (isAdmin && course.status === 'pending') {
                            actions = `<button class="btn" onclick="approveCourse('${course.id}')">Approve</button>` + actions;
                        }
                        // --- CHANGE END ---

                        return `
                        <li class="course-item">
                            <div class="course-info">
                                <h3>${course.name}</h3>
                                <div class="course-meta">
                                    ${course.holes ? course.holes.length : 0} holes • Created ${new Date(course.created_at).toLocaleDateString()}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span class="status-badge status-${course.status}">${course.status}</span>
                                <div class="course-actions">
                                    ${actions}
                                </div>
                            </div>
                        </li>
                        `
                    }).join('')}
                </ul>
            `;
        }

        // CHANGED: Renamed function and updated logic to display all courses with conditional actions
        function displayAllCoursesForAdmin(courses) {
            const container = document.getElementById('allCourses');
            
            const otherUserCourses = courses.filter(course => course.created_by !== currentUser.id);

            if (!otherUserCourses || otherUserCourses.length === 0) {
                container.innerHTML = '<div class="empty-state">No other user courses to manage</div>';
                return;
            }

            container.innerHTML = `
                <ul class="course-list">
                    ${otherUserCourses.map(course => {
                        const actions = course.status === 'pending'
                            ? `
                                <button class="btn" onclick="approveCourse('${course.id}')">Approve</button>
                                <button class="btn btn-danger" onclick="rejectCourse('${course.id}')">Reject</button>
                            `
                            : `
                                <button class="btn btn-danger" onclick="deleteCourse('${course.id}')">Delete</button>
                            `;

                        return `
                            <li class="course-item">
                                <div class="course-info">
                                    <h3>${course.name}</h3>
                                    <div class="course-meta">
                                        By ${course.creator_email || 'Unknown User'} • ${course.holes ? course.holes.length : 0} holes
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="status-badge status-${course.status}">${course.status}</span>
                                    <div class="course-actions">
                                        <button class="btn btn-secondary" onclick="editCourse('${course.id}')">Edit</button>
                                        ${actions}
                                    </div>
                                </div>
                            </li>
                        `
                    }).join('')}
                </ul>
            `;
        }


        function setupEventListeners() {
            logoutBtn.addEventListener('click', logout);
            createCourseBtn.addEventListener('click', () => openCourseModal());
            cancelCourseBtn.addEventListener('click', closeCourseModal);
            courseForm.addEventListener('submit', saveCourse);
            addHoleBtn.addEventListener('click', addHole);

            // Close modal when clicking outside
            courseModal.addEventListener('click', (e) => {
                if (e.target === courseModal) closeCourseModal();
            });
        }

        function openCourseModal(course = null) {
            editingCourse = course;
            courseHoles = [];
            
            if (course) {
                courseModalTitle.textContent = 'Edit Course';
                document.getElementById('courseName').value = course.name;
                courseCenter = [course.center_lat, course.center_lon];
                courseHoles = course.holes ? course.holes.map(h => ({
                    number: h.hole_number,
                    lat: h.lat,
                    lon: h.lon,
                    par: h.par
                })) : [];
            } else {
                courseModalTitle.textContent = 'Create New Course';
                courseForm.reset();
                courseCenter = [33.7490, -84.3880];
            }

            courseModal.classList.add('active');
            
            // Initialize map after modal is visible
            setTimeout(initializeCourseMap, 100);
        }

        function closeCourseModal() {
            courseModal.classList.remove('active');
            if (courseMap) {
                courseMap.remove();
                courseMap = null;
            }
            courseError.textContent = '';
            editingCourse = null;
            courseHoles = [];
        }

        function initializeCourseMap() {
            if (courseMap) {
                courseMap.remove();
            }

            courseMap = L.map('courseMap').setView(courseCenter, 16);

            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(courseMap);

            // Add center marker
            const centerMarker = L.marker(courseCenter, {
                draggable: true,
                icon: L.divIcon({
                    className: 'center-marker',
                    html: '🏌️',
                    iconSize: [20, 20]
                })
            }).addTo(courseMap);

            centerMarker.on('dragend', () => {
                const pos = centerMarker.getLatLng();
                courseCenter = [pos.lat, pos.lng];
            });

            // Add existing holes
            courseHoles.forEach(addHoleMarker);

            // Click to set center
            courseMap.on('click', (e) => {
                centerMarker.setLatLng([e.latlng.lat, e.latlng.lng]);
                courseCenter = [e.latlng.lat, e.latlng.lng];
            });

            updateHolesList();
        }

        function addHole() {
            const holeNumber = parseInt(document.getElementById('currentHole').value);
            const par = parseInt(document.getElementById('holePar').value);

            if (courseHoles.find(h => h.number === holeNumber)) {
                courseError.textContent = `Hole ${holeNumber} already exists`;
                return;
            }

            const hole = {
                number: holeNumber,
                lat: courseCenter[0],
                lon: courseCenter[1],
                par: par
            };

            courseHoles.push(hole);
            addHoleMarker(hole);
            updateHolesList();

            document.getElementById('currentHole').value = holeNumber + 1;
            courseError.textContent = '';
        }

        function addHoleMarker(hole) {
            const marker = L.marker([hole.lat, hole.lon], {
                draggable: true,
                icon: L.divIcon({
                    className: 'hole-marker',
                    html: hole.number,
                    iconSize: [32, 32]
                })
            }).addTo(courseMap);

            marker.on('dragend', () => {
                const pos = marker.getLatLng();
                hole.lat = pos.lat;
                hole.lon = pos.lng;
            });

            // Add pulse effect to make it more visible
            const pulseCircle = L.circle([hole.lat, hole.lon], {
                color: '#2e7d32',
                fillColor: '#4caf50',
                fillOpacity: 0.3,
                radius: 5,
                weight: 2
            }).addTo(courseMap);
            
            // Update the pulse circle position when marker is dragged
            marker.on('drag', function(e) {
                pulseCircle.setLatLng(e.target.getLatLng());
            });
            
            hole.marker = marker;
            hole.pulseCircle = pulseCircle;
        }

        function updateHolesList() {
            const container = document.getElementById('holesList');
            
            if (courseHoles.length === 0) {
                container.innerHTML = '<div class="empty-state">No holes added yet</div>';
                return;
            }

            const sortedHoles = [...courseHoles].sort((a, b) => a.number - b.number);

            container.innerHTML = sortedHoles.map(hole => `
                <div class="hole-item">
                    <span>Hole ${hole.number} (Par ${hole.par})</span>
                    <button type="button" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeHole(${hole.number})">Remove</button>
                </div>
            `).join('');
        }

        function removeHole(holeNumber) {
            const holeIndex = courseHoles.findIndex(h => h.number === holeNumber);
            if (holeIndex > -1) {
                const hole = courseHoles[holeIndex];
                if (hole.marker) {
                    courseMap.removeLayer(hole.marker);
                }
                if (hole.pulseCircle) {
                    courseMap.removeLayer(hole.pulseCircle);
                }
                courseHoles.splice(holeIndex, 1);
                updateHolesList();
            }
        }

        async function saveCourse(e) {
            e.preventDefault();
            
            const courseName = document.getElementById('courseName').value.trim();
            
            if (!courseName) {
                courseError.textContent = 'Course name is required';
                return;
            }

            if (courseHoles.length === 0) {
                courseError.textContent = 'At least one hole is required';
                return;
            }

            saveCourseBtn.disabled = true;
            saveCourseBtn.textContent = 'Checking...';
            courseError.textContent = '';

            if (!editingCourse || (editingCourse && editingCourse.name !== courseName)) {
                const { data: existingCourse, error: checkError } = await supabaseClient
                    .from('courses')
                    .select('name')
                    .eq('name', courseName)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    courseError.textContent = `Error checking course name: ${checkError.message}`;
                    saveCourseBtn.disabled = false;
                    saveCourseBtn.textContent = 'Save Course';
                    return;
                }

                if (existingCourse) {
                    courseError.textContent = 'A course with this name already exists.';
                    saveCourseBtn.disabled = false;
                    saveCourseBtn.textContent = 'Save Course';
                    return;
                }
            }

            saveCourseBtn.textContent = 'Saving...';

            try {
                let courseData = {
                    name: courseName,
                    center_lat: courseCenter[0],
                    center_lon: courseCenter[1],
                    zoom: 16,
                };

                let courseId;
                
                if (editingCourse) {
                    const { error } = await supabaseClient
                        .from('courses')
                        .update(courseData)
                        .eq('id', editingCourse.id);
                    
                    if (error) throw error;
                    courseId = editingCourse.id;

                    await supabaseClient
                        .from('holes')
                        .delete()
                        .eq('course_id', courseId);
                } else {
                    courseData.created_by = currentUser.id;
                    
                    const { data, error } = await supabaseClient
                        .from('courses')
                        .insert(courseData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    courseId = data.id;
                }

                const holesData = courseHoles.map(hole => ({
                    course_id: courseId,
                    hole_number: hole.number,
                    lat: hole.lat,
                    lon: hole.lon,
                    par: hole.par
                }));

                const { error: holesError } = await supabaseClient
                    .from('holes')
                    .insert(holesData);

                if (holesError) throw holesError;

                closeCourseModal();
                await loadUserCourses();
                // CHANGED: Refresh the admin course list after saving
                if (isAdmin) await loadAllCoursesForAdmin();
                
            } catch (error) {
                console.error('Error saving course:', error);
                courseError.textContent = error.message;
            } finally {
                saveCourseBtn.disabled = false;
                saveCourseBtn.textContent = 'Save Course';
            }
        }

        async function editCourse(courseId) {
            try {
                const { data, error } = await supabaseClient
                    .from('courses')
                    .select(`
                        *,
                        holes (*)
                    `)
                    .eq('id', courseId)
                    .single();

                if (error) throw error;
                openCourseModal(data);
            } catch (error) {
                console.error('Error loading course:', error);
                alert('Error loading course data');
            }
        }

        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course? This cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('courses')
                    .delete()
                    .eq('id', courseId);

                if (error) throw error;

                await loadUserCourses();
                // CHANGED: Refresh the admin course list after deleting
                if (isAdmin) await loadAllCoursesForAdmin();
            } catch (error) {
                console.error('Error deleting course:', error);
                alert('Error deleting course');
            }
        }

        async function approveCourse(courseId) {
            try {
                const { error } = await supabaseClient
                    .from('courses')
                    .update({ status: 'approved' })
                    .eq('id', courseId);

                if (error) throw error;
                
                // Refresh both the user's courses and the admin list to ensure the UI is consistent
                await loadUserCourses();
                if (isAdmin) {
                    await loadAllCoursesForAdmin();
                }

            } catch (error) {
                console.error('Error approving course:', error);
                alert('Error approving course');
            }
        }

        async function rejectCourse(courseId) {
            // Rejecting a course is the same as deleting it
            await deleteCourse(courseId);
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        }

        // Initialize the dashboard
        initializeDashboard();
    </script>
</body>
</html>