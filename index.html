<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simple Range Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
}

        :root {
            --primary-green: #2e7d32;
            --secondary-green: #4caf50;
            --accent-orange: #ff6e40;
            --light-green: #e8f5e8;
            --dark-green: #1b5e20;
            --background: #f8f9fa;
            --surface: #ffffff;
            --surface-variant: #f5f5f5;
            --on-surface: #1c1b1f;
            --on-surface-variant: #49454f;
            --outline: #79747e;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--on-surface);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header Improvements */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: env(safe-area-inset-top, 0) 1rem 1rem 1rem;
            position: relative;
            z-index: 1000;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .logo::before {
            content: "⛳";
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-xl);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .icon-btn:hover, .icon-btn:focus {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .icon-btn.active {
            background: var(--secondary-green);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .course-selector {
    position: relative;
    z-index: 100; /* Ensure it's above other elements */
}

.course-dropdown {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    backdrop-filter: blur(10px);
    overflow: visible; /* Changed from hidden */
    position: relative; /* Make sure this is set */
}

        .dropdown-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 52px;
        }

        .dropdown-trigger:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .course-info {
            flex: 1;
            text-align: left;
        }

        .course-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .course-meta {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .dropdown-arrow {
            font-size: 0.875rem;
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
        }

        .dropdown-arrow.open {
            transform: rotate(180deg);
        }

        .dropdown-options {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--primary-green);
    border: 1px solid #ccc;
    border-radius: var(--radius-md);
    box-shadow: 0 8px 24px rgba(235, 227, 227, 0.2);
    max-height: 60vh;
    overflow-y: auto;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    transform: translateY(-10px);
}

.dropdown-options.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--secondary-green);
    transition: background 0.2s ease;
    color: white;
}

.dropdown-option:last-child {
    border-bottom: none;
}

.dropdown-option:hover {
    background: var(--secondary-green);
}

.dropdown-option .course-name {
    color: white;
    font-weight: 500;
}

.dropdown-option .course-meta {
    color: var(--light-green);
    font-size: 0.875rem;
}

        .course-tags {
            display: flex;
            gap: 0.25rem;
        }

        .course-tag {
            background: var(--secondary-green);
            color: black;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .course-tag.pending {
            background: #ff9800;
        }

        /* Map Container */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Bottom Panel Redesign */
        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: 0 -4px 20px var(--shadow-strong);
            z-index: 2;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: env(safe-area-inset-bottom, 0);
            max-height: 75vh;
            overflow: hidden;
        }

        .bottom-panel.collapsed {
            transform: translateY(calc(100% - 120px));
        }

        .panel-handle {
            width: 36px;
            height: 4px;
            background: var(--outline);
            border-radius: 2px;
            margin: 12px auto 16px auto;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .panel-handle:hover {
            background: var(--on-surface-variant);
        }

        .panel-content {
            padding: 0 1rem 1rem 1rem;
            overflow-y: auto;
            max-height: calc(75vh - 120px);
        }

        /* Distance Display */
        .distance-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .distance-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .distance-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.875rem;
            color: var(--on-surface-variant);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--outline);
        }

        .status-dot.active {
            background: var(--secondary-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .distance-message {
            font-size: 0.875rem;
            color: var(--on-surface-variant);
        }

        /* GPS Toggle Redesign */
        .gps-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: var(--radius-md);
        }

        /* Inline version used inside distance-meta */
        .gps-section.inline {
            gap: 0.35rem;
            background: none;
        }
        .gps-section.inline .gps-label {
            font-weight: 500;
            color: var(--on-surface-variant);
            font-size: 0.875rem;
        }
        .gps-section.inline .gps-toggle {
            width: 48px;
            height: 28px;
            /* remove scale to avoid mis-alignment */
            display: inline-block;
        }
        .gps-section.inline .gps-toggle .gps-slider {
            width: 24px;
            height: 24px;
            top: 2px;
            left: 2px;
        }
        .gps-section.inline .gps-toggle.active .gps-slider {
            transform: translateX(20px);
        }

        .gps-toggle {
            position: relative;
            width: 56px;
            height: 32px;
            border-radius: 16px;
            background: red;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 2px; /* ensure slider centered vertically */
        }

        .gps-toggle.active {
            background: var(--secondary-green);
        }

        .gps-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .gps-toggle.active .gps-slider {
            transform: translateX(24px);
        }

        .gps-label {
            font-weight: 600;
            color: white;
        }
        
        /* Hole Grid Improvements */
        .holes-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--on-surface);
        }

        .hole-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .hole-card {
            background: var(--surface);
            border: 2px solid var(--outline);
            border-radius: var(--radius-md);
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hole-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--outline);
            transition: background 0.3s ease;
        }

        .hole-card.active {
            border-color: var(--secondary-green);
            background: var(--light-green);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .hole-card.active::before {
            background: var(--secondary-green);
        }

        .hole-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--on-surface);
            margin-bottom: 0.25rem;
        }

        .hole-par {
            font-size: 0.75rem;
            color: var(--on-surface-variant);
            font-weight: 500;
        }

        /* Map Markers */
        .hole-marker {
            background: var(--primary-green);
            border: 3px solid white;
            border-radius: 50%;
            color: white;
            width: 36px !important;
            height: 36px !important;
            line-height: 30px !important;
            text-align: center;
            font-weight: 700;
            box-shadow: 0 4px 12px var(--shadow-strong);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .hole-marker:hover, .hole-marker.active {
            transform: scale(1.3);
            background: var(--secondary-green);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
            z-index: 1000;
        }

        .player-marker {
    background: radial-gradient(circle, var(--accent-orange) 0%, #e64a19 100%) !important;
    border: 3px solid white !important;
    border-radius: 50% !important;
    /* dimensions not set here—circleMarker handles size via radius attribute */
    box-shadow: 0 3px 8px var(--shadow-strong) !important;
    /* removed pulse animation to prevent visual offset */
    z-index: 1000 !important;
        }
        
/* Pulse animation removed */

        /* Modal Improvements */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px var(--shadow-strong);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0 1.5rem;
            border-bottom: 1px solid var(--outline);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--on-surface);
            margin-bottom: 1rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Form Improvements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--on-surface);
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--outline);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--surface);
            color: var(--on-surface);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            background: var(--secondary-green);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 48px;
        }

        .btn:hover {
            background: var(--primary-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-variant);
            color: var(--on-surface);
            border: 2px solid var(--outline);
        }

        .btn-secondary:hover {
            background: var(--outline);
            color: var(--surface);
        }

        .error {
            color: #d32f2f;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(211, 47, 47, 0.1);
            border-radius: var(--radius-sm);
            border-left: 4px solid #d32f2f;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--on-surface-variant);
            padding: 2rem;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--outline);
            border-top-color: var(--secondary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .header {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            .logo {
                font-size: 1.125rem;
            }

            .distance-display {
                font-size: 1.75rem;
            }

            .hole-grid {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 0.5rem;
            }

            .modal-content {
                margin: 0.5rem;
                width: calc(100% - 1rem);
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #121212;
                --surface: #1e1e1e;
                --surface-variant: #2a2a2a;
                --on-surface: #e1e1e1;
                --on-surface-variant: #c7c7c7;
                --outline: #5f5f5f;
                --shadow: rgba(0, 0, 0, 0.3);
                --shadow-strong: rgba(0, 0, 0, 0.5);
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            height: 100%;
            background: var(--surface);
            box-shadow: 2px 0 12px var(--shadow-strong);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
            padding-top: calc(env(safe-area-inset-top, 0) + 1rem);
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .side-menu-header {
            display: flex;
            justify-content: flex-end;
            padding: 0 1rem 1rem 1rem;
        }

        .side-menu-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .side-menu-item {
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
            color: var(--on-surface);
            padding: 1rem 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s ease;
        }

        .side-menu-item:hover, .side-menu-item:focus {
            background: var(--surface-variant);
        }

        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 1400;
        }

        .side-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .left-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Touch improvements */
        .touchable {
            min-height: 44px;
            min-width: 44px;
        }

        /* Course display bar */
        .course-display {
            text-align: center;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: var(--surface-variant);
            color: var(--on-surface);
            border-bottom: 1px solid var(--outline);
        }

        /* dropdown search */
        .dropdown-search {
            padding: 0.75rem 1rem 0.25rem 1rem;
        }
        .dropdown-search input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--outline);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        .dropdown-search input:focus {
            outline: none;
            border-color: var(--secondary-green);
        }

        /* Focus improvements */
        .focus-visible {
            outline: 2px solid var(--secondary-green);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
<div class="app-container">
    <header class="header">
        <div class="header-top">
            <div class="left-header">
                <button class="icon-btn" id="menuBtn" aria-label="Menu">☰</button>
                <div class="logo">Simple Range Finder</div>
            </div>
            <div class="header-actions"><!-- GPS toggle moved into bottom panel --></div>
        </div>
        
        <!-- Static current-course label below header -->
        <div id="courseDisplay" class="course-display">Loading courses...</div>
    </header>

    <!-- Side Menu -->
    <div id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <button class="icon-btn" id="sideMenuClose" aria-label="Close">&times;</button>
        </div>
        <!-- Course selector moved into menu -->
        <div class="course-selector" style="padding:0 1rem 1rem 1rem;">
            <div class="course-dropdown">
                <div class="dropdown-search">
                    <input id="courseSearch" type="search" placeholder="Search courses…" autocomplete="off">
                </div>
                <div class="dropdown-trigger" id="dropdownTrigger">
                    <div class="course-info">
                        <div class="course-name">Loading courses...</div>
                        <div class="course-meta">Please wait</div>
                    </div>
                    <div class="dropdown-arrow" id="dropdownArrow">▼</div>
                </div>
                <div class="dropdown-options" id="dropdownOptions"></div>
            </div>
        </div>
        <nav class="side-menu-content">
            <button class="side-menu-item" id="helpBtn" aria-label="Help">❓ Help</button>
            <button class="side-menu-item" id="loginBtn" aria-label="Login">👤 Login</button>
            <button class="side-menu-item" id="dashboardBtn" style="display: none;" aria-label="Dashboard">📊 Dashboard</button>
            <button class="side-menu-item" id="logoutBtn" style="display: none;" aria-label="Logout">⎋ Logout</button>
        </nav>
    </div>
    <div id="sideMenuOverlay" class="side-menu-overlay"></div>

    <main class="main-content">
        <div id="map"></div>

        <div class="bottom-panel collapsed" id="bottomPanel">
            <div class="panel-handle" id="panelHandle"></div>
            <div class="panel-content">
                <div class="distance-section">
                    <div class="distance-display" id="distanceDisplay">Select a Hole</div>
                    <div class="distance-meta">
                        <div class="gps-section inline">
                            <span class="gps-label">GPS</span>
                            <div class="gps-toggle" id="gpsToggle">
                                <div class="gps-slider"></div>
                            </div>
                        </div>
                        <div class="status-indicator" id="accuracyDisplay" style="display: none;">
                            <div class="status-dot"></div>
                            <span></span>
                        </div>
                        <div class="distance-message" id="distanceMessage">
                            Turn on and select a hole to measure distance
                        </div>    
                    </div>
                </div>
                <div class="holes-section">
                    <h3>Select Hole</h3>
                    <div class="hole-grid" id="holeGrid">
                        <div class="loading">Loading holes...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="authTitle">Login</h2>
        </div>
        <div class="modal-body">
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <div class="error" id="authError" style="display: none;"></div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn" id="authSubmit">Login</button>
                    <button type="button" class="btn btn-secondary" id="authCancel">Cancel</button>
                </div>
            </form>
            <p id="authSwitch" style="margin-top: 1rem; text-align: center; cursor: pointer; color: var(--secondary-green);">
                Don't have an account? Sign up
            </p>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>How to Use</h2>
        </div>
        <div class="modal-body">
            <h3 style="color: var(--primary-green); margin-bottom: 0.5rem;">Getting Started</h3>
            <p style="margin-bottom: 1rem;">Measure distances to golf holes with precision GPS tracking.</p>
            
            <h3 style="color: var(--primary-green); margin-bottom: 0.5rem;">Quick Start</h3>
            <ol style="margin: 0 0 1rem 1.25rem;">
                <li>Select a course from the dropdown</li>
                <li>Turn on GPS tracking</li>
                <li>Tap a hole to measure distance</li>
                <li>Move around to see live updates</li>
            </ol>
            
            <h3 style="color: var(--primary-green); margin-bottom: 0.5rem;">Creating Courses</h3>
            <p style="margin-bottom: 1rem;">Log in to create and manage your own golf courses via the Dashboard.</p>
            
            <button type="button" class="btn" id="helpClose" style="width: 100%;">Got it!</button>
        </div>
    </div>
</div>

<script>
// Replace with your actual Supabase configuration
const SUPABASE_URL = 'https://ijyosisdbancyaanpdrg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqeW9zaXNkYmFuY3lhYW5wZHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTI0NTMsImV4cCI6MjA3MjU2ODQ1M30.YjZ3H1OynYfvbeABLut0tSS18mY3CLITTrUeA9wrpIg';

// Initialize Supabase
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// App state
let currentUser = null;
let courses = [];
let currentCourse = null;
let selectedHole = null;
let isTracking = false;
let watchId = null;
let map = null;
let playerMarker = null;
let distanceLine = null;
let holeMarkers = {};
let authMode = 'login';

// DOM elements
const authModal = document.getElementById('authModal');
const helpModal = document.getElementById('helpModal');
const bottomPanel = document.getElementById('bottomPanel');
const panelHandle = document.getElementById('panelHandle');
const dropdownTrigger = document.getElementById('dropdownTrigger');
const dropdownOptions = document.getElementById('dropdownOptions');
const dropdownArrow = document.getElementById('dropdownArrow');
const courseSearch = document.getElementById('courseSearch');
const gpsToggle = document.getElementById('gpsToggle');
// GPS status indicator now combined with toggle – no separate dot/text
const holeGrid = document.getElementById('holeGrid');
const distanceDisplay = document.getElementById('distanceDisplay');
const distanceMessage = document.getElementById('distanceMessage');
const courseDisplay = document.getElementById('courseDisplay');

const sideMenu = document.getElementById('sideMenu');
const sideMenuOverlay = document.getElementById('sideMenuOverlay');

// Initialize app
async function initializeApp() {
    // Restore session if it exists in localStorage
    await restoreSession();

    setupEventListeners();
    updateUserInterface();
    await loadCourses();
    
    if (courses.length > 0) {
        selectCourse(courses[0]);
        initializeMap();
        createHoleGrid();
    }
}

function setupEventListeners() {
    // Side menu toggle
    const menuBtn = document.getElementById('menuBtn');
    const sideMenuClose = document.getElementById('sideMenuClose');
    menuBtn.addEventListener('click', openSideMenu);
    sideMenuClose.addEventListener('click', closeSideMenu);
    sideMenuOverlay.addEventListener('click', closeSideMenu);

    // Dashboard button
    document.getElementById('dashboardBtn').addEventListener('click', () => {
    window.location.href = 'dashboard.html';
});
    
    // Panel toggle
    panelHandle.addEventListener('click', togglePanel);
    
    // Dropdown
    dropdownTrigger.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    toggleDropdown();
});
    // Search filter
    courseSearch.addEventListener('input', handleCourseSearch);
    
    // GPS toggle
    gpsToggle.addEventListener('click', toggleGPS);
    
    // Auth buttons
    document.getElementById('loginBtn').addEventListener('click', () => openAuthModal('login'));
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('authCancel').addEventListener('click', closeAuthModal);
    document.getElementById('authForm').addEventListener('submit', handleAuth);
    document.getElementById('authSwitch').addEventListener('click', switchAuthMode);
    
    // Help
    document.getElementById('helpBtn').addEventListener('click', openHelpModal);
    document.getElementById('helpClose').addEventListener('click', closeHelpModal);
    
    // Modal close on backdrop click
    authModal.addEventListener('click', (e) => {
        if (e.target === authModal) closeAuthModal();
    });
    helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) closeHelpModal();
    });
}

async function loadCourses() {
    try {
        const { data, error } = await supabaseClient
            .from('courses')
            .select(`
                *,
                holes (*)
            `)
            .order('name');
        
        if (error) throw error;
        
        courses = data.map(course => ({
            id: course.id,
            name: course.name,
            status: course.status,
            created_by: course.created_by,
            center: [course.center_lat, course.center_lon],
            zoom: course.zoom,
            holes: course.holes.reduce((acc, hole) => {
                acc[hole.hole_number] = {
                    lat: hole.lat,
                    lon: hole.lon,
                    par: hole.par
                };
                return acc;
            }, {})
        }));
        
        populateDropdown();
        
    } catch (error) {
        console.error('Error loading courses:', error);
        showError('Failed to load courses');
    }
}

function populateDropdown() {
    // Clear dropdown
    dropdownOptions.innerHTML = '';
    
    if (courses.length === 0) {
        updateDropdownDisplay('No courses available', 'Create a course to get started');
        return;
    }
    
    courses.forEach(course => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.dataset.courseId = course.id;
        
        const tags = [];
        if (currentUser && course.created_by === currentUser.id) {
            tags.push('my');
        }
        if (course.status === 'pending') {
            tags.push('pending');
        }
        
        option.innerHTML = `
            <div class="course-info">
                <div class="course-name">${course.name}</div>
                <div class="course-meta">${Object.keys(course.holes).length} holes</div>
            </div>
            <div class="course-tags">
                ${tags.map(tag => `<span class="course-tag ${tag}">${tag}</span>`).join('')}
            </div>
        `;
        
        option.addEventListener('click', () => {
            selectCourse(course);
            closeDropdown();
        });
        
        dropdownOptions.appendChild(option);
    });
    
    // Set first course as default
    if (courses.length > 0 && !currentCourse) {
        selectCourse(courses[0]);
    }
}

function selectCourse(course) {
    currentCourse = course;
    updateDropdownDisplay(course.name, `${Object.keys(course.holes).length} holes`);
    
    // Reset selected hole
    selectedHole = null;
    
    if (map) {
        initializeMap();
        createHoleGrid();
    }
    
    updateDistanceMessage();
}

function updateDropdownDisplay(name, meta) {
    const courseInfo = dropdownTrigger.querySelector('.course-info');
    courseInfo.querySelector('.course-name').textContent = name;
    courseInfo.querySelector('.course-meta').textContent = meta;

    if (courseDisplay) {
        courseDisplay.textContent = name;
    }
}

function toggleDropdown() {
    const isOpen = dropdownOptions.classList.contains('active');
    if (isOpen) {
        closeDropdown();
    } else {
        openDropdown();
    }
}

function openDropdown() {
    dropdownOptions.classList.add('active');
    dropdownArrow.classList.add('open');
    setTimeout(() => courseSearch?.focus(), 0);
}

function closeDropdown() {
    dropdownOptions.classList.remove('active');
    dropdownArrow.classList.remove('open');
    if (courseSearch) {
        courseSearch.value = '';
        handleCourseSearch({ target: { value: '' }});
    }
}

function handleCourseSearch(e) {
    const term = e.target.value.trim().toLowerCase();
    dropdownOptions.querySelectorAll('.dropdown-option').forEach(opt => {
        const name = opt.querySelector('.course-name').textContent.toLowerCase();
        opt.style.display = name.includes(term) ? '' : 'none';
    });
}

function togglePanel() {
    bottomPanel.classList.toggle('collapsed');
}

function toggleGPS() {
    if (isTracking) {
        stopGPS();
    } else {
        startGPS();
    }
}

function startGPS() {
    if (!navigator.geolocation) {
        showError('GPS not supported on this device');
        return;
    }

    const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    };

    watchId = navigator.geolocation.watchPosition(
        updatePosition,
        handleGPSError,
        options
    );

    isTracking = true;
    gpsToggle.classList.add('active');
    updateDistanceMessage();
}

function stopGPS() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }

    isTracking = false;
    gpsToggle.classList.remove('active');

    if (playerMarker) {
        map.removeLayer(playerMarker);
        playerMarker = null;
    }
    if (distanceLine) {
        map.removeLayer(distanceLine);
        distanceLine = null;
    }

    distanceDisplay.textContent = 'Select a Hole';
    document.getElementById('accuracyDisplay').style.display = 'none';
    updateDistanceMessage();
}

function updatePosition(position) {
    const pos = [position.coords.latitude, position.coords.longitude];

    if (!playerMarker) {
        // Use a circleMarker so the geographic point and the visible point are identical
        playerMarker = L.circleMarker(pos, {
            radius: 8,
            weight: 2,
            color: '#ffffff',          // white outline
            fillColor: '#ff6e40',      // same accent-orange as line start
            fillOpacity: 1,
            className: 'player-marker' // keep existing class for pulse animation
        }).addTo(map);
    } else {
        playerMarker.setLatLng(pos);
    }

    if (selectedHole) {
        updateDistanceLine();
        updateDistance();
    }

    // Show accuracy
    const accuracyYards = Math.round(position.coords.accuracy * 1.09361);
    const accuracyDisplay = document.getElementById('accuracyDisplay');
    accuracyDisplay.style.display = 'flex';
    accuracyDisplay.querySelector('span').textContent = `±${accuracyYards}yd`;
}

function handleGPSError(error) {
    let message = 'GPS error occurred';
    switch (error.code) {
        case error.PERMISSION_DENIED:
            message = 'GPS access denied. Please enable location services.';
            break;
        case error.POSITION_UNAVAILABLE:
            message = 'GPS position unavailable.';
            break;
        case error.TIMEOUT:
            message = 'GPS request timed out.';
            break;
    }
    showError(message);
    stopGPS();
}

function initializeMap() {
    if (!currentCourse) return;
    
    if (map) {
        map.remove();
    }

    map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView(currentCourse.center, currentCourse.zoom);

    // Add zoom control to bottom right
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri'
    }).addTo(map);

    // Clear existing markers
    holeMarkers = {};

    // Add hole markers
    Object.entries(currentCourse.holes).forEach(([number, hole]) => {
        const icon = L.divIcon({
            className: 'hole-marker',
            html: number
        });

        holeMarkers[number] = L.marker([hole.lat, hole.lon], { icon })
            .on('click', () => selectHole(number))
            .addTo(map);
    });
}

function createHoleGrid() {
    if (!currentCourse) return;

    const holes = Object.entries(currentCourse.holes)
        .sort(([a], [b]) => parseInt(a) - parseInt(b));

    holeGrid.innerHTML = holes.map(([number, hole]) => `
        <div class="hole-card touchable" data-hole="${number}">
            <div class="hole-number">#${number}</div>
            <div class="hole-par">Par ${hole.par}</div>
        </div>
    `).join('');

    // Add click handlers
    holeGrid.querySelectorAll('.hole-card').forEach(card => {
        card.addEventListener('click', () => {
            const holeNumber = card.dataset.hole;
            selectHole(holeNumber);
        });
    });
}

function selectHole(holeNumber) {
    selectedHole = holeNumber;

    // Update hole grid
    holeGrid.querySelectorAll('.hole-card').forEach(card => {
        card.classList.toggle('active', card.dataset.hole === holeNumber);
    });

    // Update map markers
    Object.entries(holeMarkers).forEach(([num, marker]) => {
        const icon = L.divIcon({
            className: 'hole-marker' + (num === holeNumber ? ' active' : ''),
            html: num
        });
        marker.setIcon(icon);
    });

    if (playerMarker) {
        updateDistanceLine();
        updateDistance();
    }

    updateDistanceMessage();
    
    // Collapse panel after selection on mobile
    if (window.innerWidth <= 768) {
        bottomPanel.classList.add('collapsed');
    }
}

function updateDistanceLine() {
    if (!selectedHole || !playerMarker || !currentCourse) return;

    const hole = currentCourse.holes[selectedHole];
    const playerPos = playerMarker.getLatLng();

    if (distanceLine) {
        map.removeLayer(distanceLine);
    }

    distanceLine = L.polyline([
        [playerPos.lat, playerPos.lng],
        [hole.lat, hole.lon]
    ], {
        color: '#ff6e40',
        weight: 3,
        opacity: 0.8,
        dashArray: '10, 10'
    }).addTo(map);
}

function updateDistance() {
    if (!selectedHole || !playerMarker || !currentCourse) return;

    const hole = currentCourse.holes[selectedHole];
    const playerPos = playerMarker.getLatLng();

    const distance = calculateDistance(
        playerPos.lat,
        playerPos.lng,
        hole.lat,
        hole.lon
    );

    const yards = Math.round(distance * 1.09361);
    distanceDisplay.textContent = `${yards} yards`;
    distanceMessage.textContent = `to hole ${selectedHole}`;
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

function updateDistanceMessage() {
    if (!isTracking) {
        distanceMessage.textContent = 'Turn on to measure distances';
    } else if (!selectedHole) {
        distanceMessage.textContent = 'Tap a hole to measure distance';
    } else {
        distanceMessage.textContent = `to hole ${selectedHole}`;
    }
}

// Session persistence and auth state listener
async function restoreSession() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session && session.user) {
            currentUser = session.user;
        }
    } catch (err) {
        console.error('Error restoring session', err);
    } finally {
        // Listen to future auth changes so UI always reflects the right state
        supabaseClient.auth.onAuthStateChange((_event, session) => {
            currentUser = session?.user || null;
            updateUserInterface();
        });
    }
}

// Auth functions
function openAuthModal(mode) {
    authMode = mode;
    document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Sign Up';
    document.getElementById('authSubmit').textContent = mode === 'login' ? 'Login' : 'Sign Up';
    document.getElementById('authSwitch').textContent = mode === 'login' 
        ? "Don't have an account? Sign up"
        : "Already have an account? Login";
    
    clearAuthError();
    authModal.classList.add('active');
}

function closeAuthModal() {
    authModal.classList.remove('active');
    document.getElementById('authForm').reset();
    clearAuthError();
}

function switchAuthMode() {
    openAuthModal(authMode === 'login' ? 'signup' : 'login');
}

async function handleAuth(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const submitBtn = document.getElementById('authSubmit');
    
    clearAuthError();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Please wait...';
    
    try {
        let result;
        if (authMode === 'login') {
            result = await supabaseClient.auth.signInWithPassword({ email, password });
        } else {
            result = await supabaseClient.auth.signUp({ email, password });
        }
        
        if (result.error) throw result.error;
        
        if (authMode === 'signup') {
            showSuccess('Please check your email to confirm your account.');
        } else {
            currentUser = result.data.user;
            updateUserInterface();
            closeAuthModal();
            showSuccess('Successfully logged in!');
        }
        
    } catch (error) {
        showAuthError(error.message || 'Authentication failed');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = authMode === 'login' ? 'Login' : 'Sign Up';
    }
}

async function logout() {
    try {
        await supabaseClient.auth.signOut();
        
        currentUser = null;
        updateUserInterface();
        showSuccess('Logged out successfully');
    } catch (error) {
        showError('Logout failed');
    }
}

function updateUserInterface() {
    const loginBtn = document.getElementById('loginBtn');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (currentUser) {
        loginBtn.style.display = 'none';
        dashboardBtn.style.display = 'flex';
        logoutBtn.style.display = 'flex';
    } else {
        loginBtn.style.display = 'flex';
        dashboardBtn.style.display = 'none';
        logoutBtn.style.display = 'none';
    }
    
    // Refresh courses to show user-specific data
    populateDropdown();
}

function openHelpModal() {
    helpModal.classList.add('active');
}

function closeHelpModal() {
    helpModal.classList.remove('active');
}

// Utility functions
function showError(message) {
    createToast(message, 'error');
}

function showSuccess(message) {
    createToast(message, 'success');
}

function createToast(message, type) {
    const toast = document.createElement('div');
    const bgColor = type === 'error' ? '#d32f2f' : 'var(--secondary-green)';
    
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        z-index: 10001;
        font-weight: 500;
        box-shadow: 0 4px 12px var(--shadow-strong);
        max-width: calc(100vw - 2rem);
        text-align: center;
        animation: slideInDown 0.3s ease;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutUp 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, type === 'error' ? 5000 : 3000);
}

function showAuthError(message) {
    const errorElement = document.getElementById('authError');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function clearAuthError() {
    const errorElement = document.getElementById('authError');
    errorElement.textContent = '';
    errorElement.style.display = 'none';
}

// Side menu controls
function openSideMenu() {
    sideMenu.classList.add('active');
    sideMenuOverlay.classList.add('active');
}

function closeSideMenu() {
    sideMenu.classList.remove('active');
    sideMenuOverlay.classList.remove('active');
    // Close course dropdown if it is open
    closeDropdown();
}

// Add CSS animations for toasts
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInDown {
        from {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutUp {
        from {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        to {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Initialize the app when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}
</script>
</body>
</html>