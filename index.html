<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Range Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2e7d32;
            color: white;
            padding: 1rem;
            position: relative;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-btn, .gps-toggle {
            background: none;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .auth-btn:hover, .gps-toggle:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }

        .gps-toggle::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff6e40;
        }

        .gps-toggle.tracking::before {
            background: #69f0ae;
        }

        .course-selector {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .course-selector select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            font-size: 1rem;
            background: transparent;
            color: white;
            cursor: pointer;
        }

        .course-selector select option {
            background: #2e7d32;
            color: white;
        }

        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .info-panel {
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 2;
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .info-panel.collapsed {
            transform: translateY(calc(100% - 80px));
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0.5rem auto;
            cursor: pointer;
        }

        .distance-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2e7d32;
            margin: 0.5rem 0;
        }

        .accuracy {
            font-size: 0.875rem;
            color: #666;
            text-align: center;
        }

        .hole-list {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            margin: 0.5rem 0;
        }

        .hole-list::-webkit-scrollbar {
            display: none;
        }

        .hole-button {
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .hole-button.active {
            background: #4caf50;
            color: white;
        }

        .hole-number {
            font-weight: bold;
        }

        .hole-par {
            opacity: 0.7;
            font-size: 0.875rem;
        }

        .hole-marker {
            background: #2e7d32;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            width: 24px !important;
            height: 24px !important;
            line-height: 24px !important;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hole-marker:hover {
            transform: scale(1.1);
            background: #4caf50;
        }

        .hole-marker.active {
            background: #4caf50;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .player-marker {
            background: #ff6e40;
            border: 2px solid white;
            border-radius: 50%;
            width: 16px !important;
            height: 16px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: #2e7d32;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4caf50;
        }

        .btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
            margin-left: 0.5rem;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .error {
            color: #d32f2f;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 2rem;
        }

        .welcome-message {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .user-controls {
                flex-wrap: wrap;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <header class="header">
        <div class="header-content">
            <h1>Golf Range Finder</h1>
            <div class="user-controls">
                <div id="userInfo" class="welcome-message" style="display: none;">
                    Welcome, <span id="userEmail"></span>!
                </div>
                <div id="authButtons">
                    <button id="loginBtn" class="auth-btn">Login</button>
                    <button id="signupBtn" class="auth-btn">Sign Up</button>
                </div>
                <div id="userButtons" style="display: none;">
                    <a href="dashboard.html" class="auth-btn">Dashboard</a>
                    <button id="logoutBtn" class="auth-btn">Logout</button>
                </div>
                <button id="gpsButton" class="gps-toggle">GPS Off</button>
            </div>
        </div>
        <div class="course-selector">
            <select id="courseSelect">
                <option value="">Loading courses...</option>
            </select>
        </div>
    </header>

    <main class="main-content">
        <div id="map"></div>

        <div class="info-panel collapsed" id="infoPanel">
            <div class="panel-handle" id="panelHandle"></div>
            <div class="distance-display" id="distanceDisplay">
                Select Hole
            </div>
            <div class="accuracy" id="accuracyDisplay"></div>
            <div class="hole-list" id="holeGrid"></div>
        </div>
    </main>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <h2 id="authTitle">Login</h2>
        <form id="authForm">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            <div class="error" id="authError"></div>
            <button type="submit" class="btn" id="authSubmit">Login</button>
            <button type="button" class="btn btn-secondary" id="authCancel">Cancel</button>
        </form>
        <p id="authSwitch" style="margin-top: 1rem; text-align: center; cursor: pointer; color: #2e7d32;">
            Don't have an account? Sign up
        </p>
    </div>
</div>

<script>
    // Replace with your Supabase URL and anon key
    const SUPABASE_URL = 'https://ijyosisdbancyaanpdrg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqeW9zaXNkYmFuY3lhYW5wZHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTI0NTMsImV4cCI6MjA3MjU2ODQ1M30.YjZ3H1OynYfvbeABLut0tSS18mY3CLITTrUeA9wrpIg';
    
    // Initialize Supabase client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // App state
    let currentUser = null;
    let courses = [];
    let currentCourse = null;
    let selectedHole = null;
    let isTracking = false;
    let watchId = null;
    let map = null;
    let playerMarker = null;
    let distanceLine = null;
    let holeMarkers = {};
    let authMode = 'login'; // 'login' or 'signup'

    // DOM elements
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authSubmit = document.getElementById('authSubmit');
    const authSwitch = document.getElementById('authSwitch');
    const authError = document.getElementById('authError');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authButtons = document.getElementById('authButtons');
    const userButtons = document.getElementById('userButtons');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const courseSelect = document.getElementById('courseSelect');
    const gpsButton = document.getElementById('gpsButton');
    const infoPanel = document.getElementById('infoPanel');
    const panelHandle = document.getElementById('panelHandle');

    // Initialize app
    async function initializeApp() {
        // Check for existing session
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            currentUser = session.user;
            updateUIForUser();
        }

        // Listen for auth changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                updateUIForUser();
                closeModal();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                updateUIForUser();
            }
        });

        // Load courses
        await loadCourses();

        // Set up event listeners
        setupEventListeners();

        // Initialize map with first course
        if (courses.length > 0) {
            currentCourse = courses[0];
            courseSelect.value = currentCourse.id;
            initializeMap();
            createHoleGrid();
        }
    }

    function updateUIForUser() {
        if (currentUser) {
            authButtons.style.display = 'none';
            userButtons.style.display = 'flex';
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;
        } else {
            authButtons.style.display = 'flex';
            userButtons.style.display = 'none';
            userInfo.style.display = 'none';
        }
    }

    async function loadCourses() {
        try {
            // The RLS policy handles security, so this query fetches all courses
            // the current user (admin or regular) is allowed to see.
            // The '*' selector already includes the 'status' and 'created_by' fields we need.
            const { data, error } = await supabaseClient
                .from('courses')
                .select(`
                    *,
                    holes (*)
                `)
                .order('name');

            if (error) throw error;

            // Map the raw data to your app's 'courses' array structure.
            // It's important to pass along status and created_by here.
            courses = data.map(course => ({
                id: course.id,
                name: course.name,
                status: course.status, // <-- Add this
                created_by: course.created_by, // <-- Add this
                center: [course.center_lat, course.center_lon],
                zoom: course.zoom,
                holes: course.holes.reduce((acc, hole) => {
                    acc[hole.hole_number] = {
                        lat: hole.lat,
                        lon: hole.lon,
                        par: hole.par
                    };
                    return acc;
                }, {})
            }));

            // Update the course selector dropdown with the new, descriptive labels.
            courseSelect.innerHTML = '<option value="">Select Course</option>';
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;

                let label = course.name;
                
                // If a course is pending, add a status indicator to its name.
                if (course.status === 'pending') {
                    // Check if the course belongs to the currently logged-in user.
                    if (currentUser && course.created_by === currentUser.id) {
                        label = `${course.name} (My Pending)`;
                    } else {
                        // If it's a pending course by another user, it will only be
                        // visible to admins due to your RLS policies.
                        label = `${course.name} (Pending Review)`;
                    }
                }
                
                option.textContent = label;
                courseSelect.appendChild(option);
            });

        } catch (error) {
            console.error('Error loading courses:', error);
            courseSelect.innerHTML = '<option value="">Error loading courses</option>';
        }
    }

    function setupEventListeners() {
        // Auth buttons
        loginBtn.addEventListener('click', () => openAuthModal('login'));
        signupBtn.addEventListener('click', () => openAuthModal('signup'));
        logoutBtn.addEventListener('click', logout);

        // Auth modal
        authForm.addEventListener('submit', handleAuth);
        document.getElementById('authCancel').addEventListener('click', closeModal);
        authSwitch.addEventListener('click', switchAuthMode);

        // Course selection
        courseSelect.addEventListener('change', handleCourseChange);

        // GPS tracking
        gpsButton.addEventListener('click', toggleTracking);

        // Panel handling
        panelHandle.addEventListener('click', () => {
            infoPanel.classList.toggle('collapsed');
        });

        // Close modal when clicking outside
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) closeModal();
        });
    }

    function openAuthModal(mode) {
        authMode = mode;
        authTitle.textContent = mode === 'login' ? 'Login' : 'Sign Up';
        authSubmit.textContent = mode === 'login' ? 'Login' : 'Sign Up';
        authSwitch.textContent = mode === 'login' 
            ? "Don't have an account? Sign up"
            : "Already have an account? Login";
        authError.textContent = '';
        authModal.classList.add('active');
    }

    function closeModal() {
        authModal.classList.remove('active');
        authForm.reset();
        authError.textContent = '';
    }

    function switchAuthMode() {
        openAuthModal(authMode === 'login' ? 'signup' : 'login');
    }

    async function handleAuth(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        authError.textContent = '';
        authSubmit.disabled = true;
        authSubmit.textContent = 'Please wait...';

        try {
            let result;
            if (authMode === 'login') {
                result = await supabaseClient.auth.signInWithPassword({ email, password });
            } else {
                result = await supabaseClient.auth.signUp({ email, password });
            }

            if (result.error) throw result.error;

            if (authMode === 'signup') {
                authError.textContent = 'Please check your email to confirm your account.';
                authError.style.color = '#2e7d32';
            }
        } catch (error) {
            authError.textContent = error.message;
        } finally {
            authSubmit.disabled = false;
            authSubmit.textContent = authMode === 'login' ? 'Login' : 'Sign Up';
        }
    }

    async function logout() {
        await supabaseClient.auth.signOut();
    }

    function handleCourseChange() {
        const courseId = courseSelect.value;
        if (courseId) {
            currentCourse = courses.find(c => c.id === courseId);
            if (currentCourse) {
                initializeMap();
                createHoleGrid();
            }
        }
    }

    // Initialize map
    function initializeMap() {
        if (map) {
            map.remove();
        }

        map = L.map('map').setView(currentCourse.center, currentCourse.zoom);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        // Clear existing markers
        holeMarkers = {};

        // Add hole markers
        Object.entries(currentCourse.holes).forEach(([number, position]) => {
            const icon = L.divIcon({
                className: 'hole-marker' + (selectedHole === number ? ' active' : ''),
                html: number
            });

            holeMarkers[number] = L.marker([position.lat, position.lon], {icon})
                .on('click', () => selectHole(number))
                .addTo(map);
        });
    }

    // Create hole selection list
    function createHoleGrid() {
        const grid = document.getElementById('holeGrid');
        grid.innerHTML = '';

        Object.entries(currentCourse.holes).forEach(([number, data]) => {
            const button = document.createElement('button');
            button.className = 'hole-button' + (selectedHole === number ? ' active' : '');
            button.innerHTML = `
                <span class="hole-number">#${number}</span>
                <span class="hole-par">Par ${data.par}</span>
            `;

            button.addEventListener('click', () => selectHole(number));
            grid.appendChild(button);
        });
    }

    // Hole selection handler
    function selectHole(number) {
        selectedHole = number;

        // Update hole list UI
        document.querySelectorAll('.hole-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.querySelector('.hole-number').textContent === `#${number}`) {
                btn.classList.add('active');
            }
        });

        // Update map markers
        Object.entries(holeMarkers).forEach(([holeNum, marker]) => {
            const icon = L.divIcon({
                className: 'hole-marker' + (holeNum === number ? ' active' : ''),
                html: holeNum
            });
            marker.setIcon(icon);
        });

        // Ensure selected hole button is visible
        const activeButton = document.querySelector('.hole-button.active');
        if (activeButton) {
            activeButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        if (playerMarker) {
            updateDistanceLine();
            updateDistance();
        }

        // Auto-collapse the panel
        infoPanel.classList.add('collapsed');
    }

    // Calculate distance (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
    }

    function metersToYards(meters) {
        return Math.round(meters * 1.09361);
    }

    function updateDistanceLine() {
        if (!selectedHole || !playerMarker) return;

        const hole = currentCourse.holes[selectedHole];
        const playerPos = playerMarker.getLatLng();

        if (distanceLine) {
            map.removeLayer(distanceLine);
        }

        distanceLine = L.polyline([
            [playerPos.lat, playerPos.lng],
            [hole.lat, hole.lon]
        ], {
            color: '#ff6e40',
            weight: 2,
            opacity: 0.8,
            dashArray: '5, 10'
        }).addTo(map);
    }

    function updateDistance() {
        if (!selectedHole || !playerMarker) return;

        const hole = currentCourse.holes[selectedHole];
        const playerPos = playerMarker.getLatLng();

        const distance = calculateDistance(
            playerPos.lat,
            playerPos.lng,
            hole.lat,
            hole.lon
        );

        const yards = metersToYards(distance);
        document.getElementById('distanceDisplay').textContent = `${yards} yards to hole ${selectedHole}`;
    }

    // GPS tracking functions
    function toggleTracking() {
        if (isTracking) {
            stopTracking();
            gpsButton.textContent = 'GPS Off';
            gpsButton.classList.remove('tracking');
        } else {
            startTracking();
            gpsButton.textContent = 'GPS On';
            gpsButton.classList.add('tracking');
        }
    }

    function startTracking() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }

        watchId = navigator.geolocation.watchPosition(
            updatePosition,
            handleGPSError,
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );

        isTracking = true;
    }

    function stopTracking() {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        isTracking = false;

        if (playerMarker) {
            map.removeLayer(playerMarker);
            playerMarker = null;
        }
        if (distanceLine) {
            map.removeLayer(distanceLine);
            distanceLine = null;
        }

        document.getElementById('distanceDisplay').textContent = 'Select Hole';
        document.getElementById('accuracyDisplay').textContent = '';
    }

    function updatePosition(position) {
        const pos = [position.coords.latitude, position.coords.longitude];

        if (!playerMarker) {
            const icon = L.divIcon({ className: 'player-marker' });
            playerMarker = L.marker(pos, {icon}).addTo(map);
        } else {
            playerMarker.setLatLng(pos);
        }

        if (selectedHole) {
            updateDistanceLine();
            updateDistance();
        }

        const accuracyYards = metersToYards(position.coords.accuracy);
        document.getElementById('accuracyDisplay').textContent =
            `GPS Accuracy: ±${accuracyYards} yards`;
    }

    function handleGPSError(error) {
        if (error.code === 1) {
            alert('Please enable location services to use this app');
            stopTracking();
        } else {
            alert('Error getting your location');
        }
    }

    // Initialize the app (called after Supabase is ready)
    initializeApp(); // Remove this line since it's now called from initializeSupabase()
</script>
</body>
</html>