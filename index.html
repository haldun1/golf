<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simple Range Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
}

        :root {
            /* Primary brand colours */
            --primary-green: #0d9488;
            --primary-green-half: hsl(175, 84%, 32%, 50%);
            --secondary-green: #14b8a6;
            --accent-orange: #f59e0b;
            --accent-orange-half: hsl(38, 92%, 50%, 50%);
            --light-green: #5eead4;
            --dark-green: #134e4a;

            /* Surfaces & text*/
            --background: #0f172a;
            --surface: #1e293b;
            --surface-variant: #334155;
            --on-surface: #f1f5f9;
            --on-surface-variant: #cbd5e1;
            --outline: #475569;
            --off: #ef4444;

            /* Shadows */
            --shadow: rgba(0,0,0,0.25);
            --shadow-strong: rgba(0,0,0,0.5);

            /* Radii */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        *{
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--on-surface);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: env(safe-area-inset-top, 0) 1rem 1rem 1rem;
            position: relative;
            z-index: 1000;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-top: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .logo::before {
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--on-surface);
            width: 44px;
            height: 44px;
            border-radius: var(--radius-xl);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s ease;
            backdrop-filter: blur(6px);
        }

        .icon-btn:hover, .icon-btn:focus {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .icon-btn.active {
            background: var(--secondary-green);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .course-selector {
    position: relative;
    z-index: 100; /* Ensure it's above other elements */
}

.course-dropdown {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    backdrop-filter: blur(10px);
    overflow: visible;
    position: relative;
}

        .dropdown-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 52px;
        }

        .dropdown-trigger:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .course-info {
            flex: 1;
            text-align: left;
        }

        .course-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .course-meta {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .dropdown-arrow {
            font-size: 0.875rem;
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
        }

        .dropdown-arrow.open {
            transform: rotate(180deg);
        }

        .dropdown-options {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--surface-variant);
    border: 1px solid #ccc;
    border-radius: var(--radius-md);
    box-shadow: 0 8px 24px rgba(235, 227, 227, 0.2);
    max-height: 60vh;
    overflow-y: auto;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    transform: translateY(-10px);
}

.dropdown-options.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--outline);
    transition: background 0.2s ease;
    color: white;
}

.dropdown-option:last-child {
    border-bottom: none;
}

.dropdown-option:hover {
    background: var(--surface);
}

.dropdown-option .course-name {
    color: white;
    font-weight: 500;
}

.dropdown-option .course-meta {
    color: var(--on-surface-variant);
    font-size: 0.875rem;
}

        .course-tags {
            display: flex;
            gap: 0.25rem;
        }

        .course-tag {
            background: var(--secondary-green);
            color: var(--on-surface);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .course-tag.pending {
            background: var(--accent-orange);
            color: #000;
        }

        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: 0 -4px 20px var(--shadow-strong);
            z-index: 2;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: env(safe-area-inset-bottom, 0);
            max-height: 75vh;
            overflow: hidden;
        }

        .bottom-panel.collapsed {
            transform: translateY(calc(100% - 120px));
        }

        .bottom-panel.dragging {
            transition: none;
        }

        #panelHeader {
            cursor: grab;
            text-align: center;
        }

        .panel-handle {
            width: 36px;
            height: 4px;
            background: var(--outline);
            border-radius: 2px;
            margin: 12px auto 16px auto;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .panel-handle:hover {
            background: var(--on-surface-variant);
        }

        .panel-content {
            padding: 0 1rem 1rem 1rem;
            overflow-y: auto;
            max-height: calc(75vh - 120px);
        }

        .distance-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .distance-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--light-green);
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .distance-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.875rem;
            color: var(--on-surface-variant);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--outline);
        }

        .status-dot.active {
            background: var(--secondary-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .distance-message {
            font-size: 0.875rem;
            color: var(--on-surface-variant);
        }

        .gps-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: var(--radius-md);
        }

        .gps-section.inline {
            gap: 0.35rem;
            background: none;
        }
        .gps-section.inline .gps-label {
            font-weight: 500;
            color: var(--on-surface-variant);
            font-size: 0.875rem;
        }
        .gps-section.inline .gps-toggle {
            width: 48px;
            height: 28px;
            display: inline-block;
        }
        .gps-section.inline .gps-toggle .gps-slider {
            width: 24px;
            height: 24px;
            top: 2px;
            left: 2px;
        }
        .gps-section.inline .gps-toggle.active .gps-slider {
            transform: translateX(20px);
        }

        .gps-toggle {
            position: relative;
            width: 56px;
            height: 32px;
            border-radius: 16px;
            background: var(--off);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 2px;
        }

        .gps-toggle.active {
            background: var(--secondary-green);
        }

        .gps-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .gps-toggle.active .gps-slider {
            transform: translateX(24px);
        }

        .gps-label {
            font-weight: 600;
            color: white;
        }
        
        .holes-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--on-surface);
        }

        .hole-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .hole-card {
            background: var(--surface);
            border: 2px solid var(--outline);
            border-radius: var(--radius-md);
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hole-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--outline);
            transition: background 0.3s ease;
        }

        .hole-card.active {
            border-color: var(--secondary-green);
            background: var(--primary-green);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .hole-card.active::before {
            background: var(--secondary-green);
        }

        .hole-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--on-surface);
            margin-bottom: 0.25rem;
        }

        .hole-par {
            font-size: 0.75rem;
            color: var(--on-surface-variant);
            font-weight: 500;
        }

        .hole-marker {
            background: var(--primary-green-half);
            border: 3px solid white;
            border-radius: 50%;
            color: white;
            width: 36px !important;
            height: 36px !important;
            line-height: 30px !important;
            text-align: center;
            font-weight: 700;
            box-shadow: 0 4px 12px var(--shadow-strong);
            cursor: pointer;
            transition: 0.3s;
            font-size: 16px;
        }

        .hole-marker:hover {
            transform: scale(1.1);
            z-index: 1000;
        }

        .hole-marker.active {
            background: rgb(1, 32, 0);
            z-index: 999;
        }

        .player-marker {
    background: var(--accent-orange-half) !important;
    border: 3px solid white !important;
    border-radius: 50% !important;
    box-shadow: 0 3px 8px var(--shadow-strong) !important;
    z-index: 1000 !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px var(--shadow-strong);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0 1.5rem;
            border-bottom: 1px solid var(--outline);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--on-surface);
            margin-bottom: 1rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .help-section {
            margin-bottom: 1.5rem;
        }
        .help-section:last-of-type {
            margin-bottom: 0;
        }
        .help-section h3 {
            color: var(--primary-green);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .help-section p, .help-section li {
            color: var(--on-surface-variant);
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        .help-section ul, .help-section ol {
            padding-left: 1.25rem;
        }
        .help-section strong {
            color: var(--on-surface);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--on-surface);
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--outline);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--surface);
            color: var(--on-surface);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            background: var(--secondary-green);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 48px;
        }

        .btn:hover {
            background: var(--primary-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-variant);
            color: var(--on-surface);
            border: 2px solid var(--outline);
        }

        .btn-secondary:hover {
            background: var(--outline);
            color: var(--surface);
        }

        .error {
            color: #d32f2f;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(211, 47, 47, 0.1);
            border-radius: var(--radius-sm);
            border-left: 4px solid #d32f2f;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--on-surface-variant);
            padding: 2rem;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--outline);
            border-top-color: var(--secondary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .header {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            .logo {
                font-size: 1.125rem;
            }

            .distance-display {
                font-size: 1.75rem;
            }

            .hole-grid {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 0.5rem;
            }

            .modal-content {
                margin: 0.5rem;
                width: calc(100% - 1rem);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            height: 100%;
            background: var(--surface);
            box-shadow: 2px 0 12px var(--shadow-strong);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
            padding-top: calc(env(safe-area-inset-top, 0) + 1rem);
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .side-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem 1rem 1.25rem;
        }

        .side-menu-user {
            font-weight: 500;
            color: var(--on-surface-variant);
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100% - 60px);
        }

        .side-menu-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .side-menu-item {
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
            color: var(--on-surface-variant);
            padding: 1rem 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s ease;
        }

        .side-menu-item:hover, .side-menu-item:focus {
            background: var(--surface-variant);
        }

        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 1400;
        }

        .side-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .side-menu-item-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    color: var(--on-surface-variant);
}

.unit-toggle {
    display: flex;
    background: var(--surface-variant);
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--outline);
    margin-left: auto; /* Pushes the toggle to the right */
}

.unit-btn {
    background: none;
    border: none;
    color: var(--on-surface-variant);
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
    font-size: 0.875rem;
    font-weight: 500;
}

.unit-btn.active {
    background: var(--secondary-green);
    color: white;
}

        .left-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .touchable {
            min-height: 44px;
            min-width: 44px;
        }

        .course-display {
            text-align: center;
            font-weight: 600;
            color: var(--on-surface);
        }

        .dropdown-search {
            padding: 0.75rem 1rem 0.25rem 1rem;
        }
        .dropdown-search input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--outline);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        .dropdown-search input:focus {
            outline: none;
            border-color: var(--secondary-green);
        }

        .focus-visible {
            outline: 2px solid var(--secondary-green);
            outline-offset: 2px;
        }

        .leaflet-zoom-anim .hole-marker {
            transition: none;
        }
        
        /* Measurement Tool Styles */
        .measurement-control {
            display: none; /* Hidden by default */
        }
        .measurement-control a {
            background-color: white;
            border: 2px solid var(--outline);
            color: black;
            font-family: 'Material Symbols Outlined';
            width: 34px;
            height: 34px;
            line-height: 30px;
            font-size: 22px;
        }
        .measurement-control a:hover {
            background-color: var(--on-surface-variant);
        }
        .measurement-control.active a {
            background-color: var(--primary-green);
            color: white;
            border-color: var(--secondary-green);
        }

        .measure-marker-icon {
            background: var(--accent-orange);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 8px var(--shadow-strong);
            cursor: move;
        }

        .distance-tooltip {
            background: rgba(15, 23, 42, 0.8); /* --background with transparency */
            border: 1px solid var(--outline);
            color: var(--on-surface);
            font-weight: bold;
            box-shadow: none;
        }

    </style>
</head>
<body>
<div class="app-container">
    <header class="header">
        <div class="header-top">
            <button class="icon-btn material-symbols-outlined" id="menuBtn" aria-label="Menu">menu</button>
            
            <div class="logo"><span class="material-symbols-outlined">golf_course</span> Simple Range Finder</div>

            <div class="header-actions">
                <button class="icon-btn material-symbols-outlined" id="mainHelpBtn" aria-label="Help">help</button>
            </div>
        </div>
        
        <div id="courseDisplay" class="course-display">Loading courses...</div>
    </header>

    <div id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <div id="sideMenuUser" class="side-menu-user" style="display: none;"></div>
            <button class="icon-btn" id="sideMenuClose" aria-label="Close">&times;</button>
        </div>
        <div class="course-selector" style="padding:0 1rem 1rem 1rem;">
            <div class="course-dropdown">
                <div class="dropdown-search">
                    <input id="courseSearch" type="search" placeholder="Search courses…" autocomplete="off">
                </div>
                <div class="dropdown-trigger" id="dropdownTrigger">
                    <div class="course-info">
                        <div class="course-name">Loading courses...</div>
                        <div class="course-meta">Please wait</div>
                    </div>
                    <div class="dropdown-arrow" id="dropdownArrow">▼</div>
                </div>
                <div class="dropdown-options" id="dropdownOptions"></div>
            </div>
        </div>
        <nav class="side-menu-content">
            <button class="side-menu-item" id="loginBtn" aria-label="Login">
                <span class="material-symbols-outlined">account_circle</span>
                Login
            </button>
            <button class="side-menu-item" id="logoutBtn" style="display: none;" aria-label="Logout">
                <span class="material-symbols-outlined">logout</span>
                Logout
            </button>
            <button class="side-menu-item" id="dashboardBtn" style="display: none;" aria-label="Dashboard">
                <span class="material-symbols-outlined">dashboard</span>
                Dashboard
            </button>
            <div class="side-menu-item-group">
                <span class="material-symbols-outlined">straighten</span>
                <div class="unit-toggle">
                    <button class="unit-btn active" data-unit="yards">Yards</button>
                    <button class="unit-btn" data-unit="meters">Meters</button>
                </div>
            </div>
            <button class="side-menu-item" id="helpBtn" aria-label="Help">
                <span class="material-symbols-outlined">help</span>
                Help
            </button>

        </nav>
    </div>
    <div id="sideMenuOverlay" class="side-menu-overlay"></div>

    <main class="main-content">
        <div id="map"></div>
        <div class="bottom-panel collapsed" id="bottomPanel">
            
            <div id="panelHeader">
                <div class="panel-handle" id="panelHandle"></div>
                <div class="distance-display" id="distanceDisplay">Select a Hole</div>
            </div>

            <div class="panel-content">
                <div class="distance-section">
                    <div class="distance-meta">
                        <div class="gps-section inline">
                            <span class="gps-label">GPS</span>
                            <div class="gps-toggle" id="gpsToggle">
                                <div class="gps-slider"></div>
                            </div>
                        </div>
                        <div class="status-indicator" id="accuracyDisplay" style="display: none;">
                            <div class="status-dot"></div>
                            <span></span>
                        </div>
                        <div class="distance-message" id="distanceMessage">
                            Turn on and select a hole to measure distance
                        </div>    
                    </div>
                </div>
                <div class="holes-section">
                    <h3>Select Hole</h3>
                    <div class="hole-grid" id="holeGrid">
                        <div class="loading">Loading holes...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="authTitle">Login</h2>
        </div>
        <div class="modal-body">
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <div class="error" id="authError" style="display: none;"></div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn" id="authSubmit">Login</button>
                    <button type="button" class="btn btn-secondary" id="authCancel">Cancel</button>
                </div>
            </form>
            <p id="authSwitch" style="margin-top: 1rem; text-align: center; cursor: pointer; color: var(--secondary-green);">
                Don't have an account? Sign up
            </p>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>How to Use</h2>
        </div>
        <div class="modal-body">
            <div class="help-section">
                <h3>⚡ Quick Start</h3>
                <ol>
                    <li><strong>Choose a course:</strong> Tap the menu (☰) and pick one.</li>
                    <li><strong>Enable GPS:</strong> Tap the GPS toggle. Allow the browser to use your location.</li>
                    <li><strong>Select a hole:</strong> Tap a green marker on the map or in the bottom panel. The yardage appears and updates as you walk.</li>
                </ol>
            </div>
            <div class="help-section">
                <h3>📏 Measurement Tool</h3>
                <p>After selecting a hole, a new ruler icon (<span class="material-symbols-outlined" style="font-size: 1em; vertical-align: -0.1em;">straighten</span>) will appear. Tap it to drop a movable measurement dot on the hole. Drag this dot to see distances from it to the hole and your current location.</p>
            </div>
            <div class="help-section">
                <h3>🎛️ Controls & Tips</h3>
                <ul>
                    <li><strong>Map:</strong> Pinch-zoom and pan just like any other map.</li>
                    <li><strong>Accuracy:</strong> A ± value shows how precise the current GPS reading is.</li>
                    <li><strong>GPS off?</strong> Toggle it anytime to stop tracking and save battery.</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>➕ Create Your Own Courses</h3>
                <p>Log in or sign up from the menu to open your Dashboard. There you can create new courses or edit existing ones.</p>
                <p>When you save a new course, it will be available to you immediately, and to everyone else once the admin approves it.</p>
            </div>
            <button type="button" class="btn" id="helpClose" style="width: 100%; margin-top: 1rem;">Got it!</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://ijyosisdbancyaanpdrg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqeW9zaXNkYmFuY3lhYW5wZHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTI0NTMsImV4cCI6MjA3MjU2ODQ1M30.YjZ3H1OynYfvbeABLut0tSS18mY3CLITTrUeA9wrpIg';

// Initialize Supabase
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// App state
let currentUser = null;
let courses = [];
let currentCourse = null;
let selectedHole = null;
let isTracking = false;
let watchId = null;
let map = null;
let playerMarker = null;
let lastPlayerPos = null;
let distanceLine = null;
let holeMarkers = {};
let authMode = 'login';
let isDraggingPanel = false;
let panelDragStartPos = 0;
let initialPanelOffset = 0;
let currentPanelOffset = 0;
let currentUnit = 'yards';
let lastAccuracyYards = 0;
const YARDS_TO_METERS = 0.9144;

// Measurement tool state
let isMeasuring = false;
let measureMarker = null;
let measureLineToHole = null;
let measureLineToUser = null;
let measureControl = null;


// DOM elements
const authModal = document.getElementById('authModal');
const helpModal = document.getElementById('helpModal');
const bottomPanel = document.getElementById('bottomPanel');
const panelHandle = document.getElementById('panelHandle');
const panelHeader = document.getElementById('panelHeader');
const dropdownTrigger = document.getElementById('dropdownTrigger');
const dropdownOptions = document.getElementById('dropdownOptions');
const dropdownArrow = document.getElementById('dropdownArrow');
const courseSearch = document.getElementById('courseSearch');
const gpsToggle = document.getElementById('gpsToggle');
const holeGrid = document.getElementById('holeGrid');
const distanceDisplay = document.getElementById('distanceDisplay');
const distanceMessage = document.getElementById('distanceMessage');
const courseDisplay = document.getElementById('courseDisplay');

const sideMenu = document.getElementById('sideMenu');
const sideMenuOverlay = document.getElementById('sideMenuOverlay');



// Initialize app
async function initializeApp() {
    const savedUnit = localStorage.getItem('preferredUnit');
    if (savedUnit && (savedUnit === 'yards' || savedUnit === 'meters')) {
        currentUnit = savedUnit;
        document.querySelectorAll('.unit-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.unit === currentUnit);
        });
    }
    
    // Restore session if it exists in localStorage
    await restoreSession();

    setupEventListeners();
    updateUserInterface();
    await loadCourses();
    
    if (courses.length > 0) {
        selectCourse(courses[0]);
        initializeMap();
        createHoleGrid();
    }
}

function setupEventListeners() {
    // Side menu toggle
    const menuBtn = document.getElementById('menuBtn');
    const sideMenuClose = document.getElementById('sideMenuClose');
    menuBtn.addEventListener('click', openSideMenu);
    sideMenuClose.addEventListener('click', closeSideMenu);
    sideMenuOverlay.addEventListener('click', closeSideMenu);

    // Dashboard button
    document.getElementById('dashboardBtn').addEventListener('click', () => {
    window.location.href = 'dashboard.html';
});
    
    // Panel toggle
    panelHeader.addEventListener('mousedown', startPanelDrag);
    panelHeader.addEventListener('touchstart', startPanelDrag, { passive: false });
    
    // Dropdown
    dropdownTrigger.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    toggleDropdown();
});
    // Search filter
    courseSearch.addEventListener('input', handleCourseSearch);
    
    // GPS toggle
    gpsToggle.addEventListener('click', toggleGPS);
    
    // Auth buttons
    document.getElementById('loginBtn').addEventListener('click', () => openAuthModal('login'));
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('authCancel').addEventListener('click', closeAuthModal);
    document.getElementById('authForm').addEventListener('submit', handleAuth);
    document.getElementById('authSwitch').addEventListener('click', switchAuthMode);
    
    // Help
    document.getElementById('helpBtn').addEventListener('click', openHelpModal);
    document.getElementById('helpClose').addEventListener('click', closeHelpModal);
    document.getElementById('mainHelpBtn').addEventListener('click', openHelpModal);
    
    // Modal close on backdrop click
    authModal.addEventListener('click', (e) => {
        if (e.target === authModal) closeAuthModal();
    });
    helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) closeHelpModal();
    });

    document.querySelector('.unit-toggle').addEventListener('click', handleUnitChange);
}

async function loadCourses() {
    try {
        const { data, error } = await supabaseClient
            .from('courses')
            .select(`
                *,
                holes (*)
            `)
            .order('name');
        
        if (error) throw error;
        
        courses = data.map(course => ({
            id: course.id,
            name: course.name,
            status: course.status,
            created_by: course.created_by,
            center: [course.center_lat, course.center_lon],
            zoom: course.zoom,
            holes: course.holes.reduce((acc, hole) => {
                acc[hole.hole_number] = {
                    lat: hole.lat,
                    lon: hole.lon,
                    par: hole.par
                };
                return acc;
            }, {})
        }));
        
        populateDropdown();
        
    } catch (error) {
        console.error('Error loading courses:', error);
        showError('Failed to load courses');
    }
}

function populateDropdown() {
    // Clear dropdown
    dropdownOptions.innerHTML = '';
    
    if (courses.length === 0) {
        updateDropdownDisplay('No courses available', 'Create a course to get started');
        return;
    }
    
    courses.forEach(course => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.dataset.courseId = course.id;
        
        const tags = [];
        if (currentUser && course.created_by === currentUser.id) {
            tags.push('my');
        }
        if (course.status === 'pending') {
            tags.push('pending');
        }
        
        option.innerHTML = `
            <div class="course-info">
                <div class="course-name">${course.name}</div>
                <div class="course-meta">${Object.keys(course.holes).length} holes</div>
            </div>
            <div class="course-tags">
                ${tags.map(tag => `<span class="course-tag ${tag}">${tag}</span>`).join('')}
            </div>
        `;
        
        option.addEventListener('click', () => {
            selectCourse(course);
            closeDropdown();
        });
        
        dropdownOptions.appendChild(option);
    });
    
    // Set first course as default
    if (courses.length > 0 && !currentCourse) {
        selectCourse(courses[0]);
    }
}

function selectCourse(course) {
    currentCourse = course;
    updateDropdownDisplay(course.name, `${Object.keys(course.holes).length} holes`);
    
    // Reset selected hole
    selectedHole = null;
    
    if (map) {
        initializeMap();
        createHoleGrid();
    }
    
    updateDistanceMessage();
}

function updateDropdownDisplay(name, meta) {
    const courseInfo = dropdownTrigger.querySelector('.course-info');
    courseInfo.querySelector('.course-name').textContent = name;
    courseInfo.querySelector('.course-meta').textContent = meta;

    if (courseDisplay) {
        courseDisplay.textContent = name;
    }
}

function toggleDropdown() {
    const isOpen = dropdownOptions.classList.contains('active');
    if (isOpen) {
        closeDropdown();
    } else {
        openDropdown();
    }
}

function openDropdown() {
    dropdownOptions.classList.add('active');
    dropdownArrow.classList.add('open');
    setTimeout(() => courseSearch?.focus(), 0);
}

function closeDropdown() {
    dropdownOptions.classList.remove('active');
    dropdownArrow.classList.remove('open');
    if (courseSearch) {
        courseSearch.value = '';
        handleCourseSearch({ target: { value: '' }});
    }
}

function handleCourseSearch(e) {
    const term = e.target.value.trim().toLowerCase();
    dropdownOptions.querySelectorAll('.dropdown-option').forEach(opt => {
        const name = opt.querySelector('.course-name').textContent.toLowerCase();
        opt.style.display = name.includes(term) ? '' : 'none';
    });
}

function togglePanel() {
    bottomPanel.classList.toggle('collapsed');
}

function toggleGPS() {
    if (isTracking) {
        stopGPS();
    } else {
        startGPS();
    }
}

function startGPS() {
    if (!navigator.geolocation) {
        showError('GPS not supported on this device');
        return;
    }

    const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    };

    watchId = navigator.geolocation.watchPosition(
        updatePosition,
        handleGPSError,
        options
    );

    isTracking = true;
    gpsToggle.classList.add('active');
    updateDistanceMessage();
}

function stopGPS() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }

    isTracking = false;
    gpsToggle.classList.remove('active');
    lastAccuracyYards = 0; // Add this line
    updateAccuracyDisplay(); // Add this line to hide the display

    if (playerMarker) {
        map.removeLayer(playerMarker);
        playerMarker = null;
    }
    if (distanceLine) {
        map.removeLayer(distanceLine);
        distanceLine = null;
    }
    lastPlayerPos = null;

    distanceDisplay.textContent = 'Select a Hole';
    document.getElementById('accuracyDisplay').style.display = 'none';
    updateDistanceMessage();
}

function updatePosition(position) {
    const pos = [position.coords.latitude, position.coords.longitude];
    lastPlayerPos = pos;

    if (!playerMarker) {
        playerMarker = L.circleMarker(pos, {
            radius: 8,
            weight: 2,
            color: '#ffffff',
            fillColor: '#ff6e40',
            fillOpacity: 1,
            className: 'player-marker'
        }).addTo(map);
    } else {
        playerMarker.setLatLng(pos);
    }

    if (selectedHole) {
        updateDistanceLine();
        updateDistance();
    }

    if (isMeasuring) {
        updateMeasurementVisuals();
    }

    // Show accuracy
    const accuracyYards = Math.round(position.coords.accuracy * 1.09361);
    lastAccuracyYards = accuracyYards;
    updateAccuracyDisplay();
}

function updateAccuracyDisplay() {
    if (lastAccuracyYards <= 0 || !isTracking) {
        document.getElementById('accuracyDisplay').style.display = 'none';
        return;
    };

    const accuracyDisplay = document.getElementById('accuracyDisplay');
    accuracyDisplay.style.display = 'flex';

    if (currentUnit === 'meters') {
        const accuracyMeters = Math.round(lastAccuracyYards * YARDS_TO_METERS);
        accuracyDisplay.querySelector('span').textContent = `±${accuracyMeters}m`;
    } else {
        accuracyDisplay.querySelector('span').textContent = `±${lastAccuracyYards}yd`;
    }
}

function handleGPSError(error) {
    let message = 'GPS error occurred';
    switch (error.code) {
        case error.PERMISSION_DENIED:
            message = 'GPS access denied. Please enable location services.';
            break;
        case error.POSITION_UNAVAILABLE:
            message = 'GPS position unavailable.';
            break;
        case error.TIMEOUT:
            message = 'GPS request timed out.';
            break;
    }
    showError(message);
    stopGPS();
}

function handleUnitChange(e) {
    const button = e.target.closest('.unit-btn');
    if (!button) return;

    const selectedUnit = button.dataset.unit;
    if (selectedUnit === currentUnit) return;

    currentUnit = selectedUnit;
    localStorage.setItem('preferredUnit', currentUnit); // Persist choice

    // Update button styles
    document.querySelectorAll('.unit-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.unit === currentUnit);
    });

    // Re-render distances if a position and hole are selected
    if (lastPlayerPos && selectedHole) {
        updateDistance();
    }
    
    if (isMeasuring) {
        updateMeasurementVisuals();
    }

    // Re-render accuracy if GPS is active
    updateAccuracyDisplay();
}

function initializeMap() {
    if (!currentCourse) return;
    
    if (map) {
        map.remove();
        playerMarker = null;
        distanceLine = null;
        measureControl = null;
    }

    map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    });

    const holeCoords = Object.values(currentCourse.holes).map(h => [h.lat, h.lon]);

    if (holeCoords.length > 0) {
        map.fitBounds(holeCoords, { padding: [50, 50] });
    } else {
        map.setView(currentCourse.center, currentCourse.zoom);
    }

    L.control.zoom({ position: 'topleft' }).addTo(map);

    if (isTracking && lastPlayerPos) {
        playerMarker = L.circleMarker(lastPlayerPos, {
            radius: 8,
            weight: 2,
            color: '#ffffff',
            fillColor: '#ff6e40',
            fillOpacity: 1,
            className: 'player-marker'
        }).addTo(map);
    }

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri',
            maxNativeZoom: 19,
            maxZoom: 22
        }).addTo(map);

    holeMarkers = {};

    Object.entries(currentCourse.holes).forEach(([number, hole]) => {
            const icon = L.divIcon({
                className: 'hole-marker',
                html: number,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });

        holeMarkers[number] = L.marker([hole.lat, hole.lon], { icon })
            .on('click', () => selectHole(number))
            .addTo(map);
    });

    // Initialize measurement control
    L.Control.Measure = L.Control.extend({
        onAdd: function(map) {
            const container = L.DomUtil.create('div', 'leaflet-bar measurement-control');
            container.innerHTML = '<a href="#" title="Toggle Measurement Tool">straighten</a>';
            L.DomEvent.on(container, 'click', L.DomEvent.stop)
                      .on(container, 'click', toggleMeasurement);
            return container;
        },
        onRemove: function(map) {}
    });
    measureControl = new L.Control.Measure({ position: 'topright' }).addTo(map);
}

function createHoleGrid() {
    if (!currentCourse) return;

    const holes = Object.entries(currentCourse.holes)
        .sort(([a], [b]) => parseInt(a) - parseInt(b));

    holeGrid.innerHTML = holes.map(([number, hole]) => `
        <div class="hole-card touchable" data-hole="${number}">
            <div class="hole-number">#${number}</div>
            <div class="hole-par">Par ${hole.par}</div>
        </div>
    `).join('');

    holeGrid.querySelectorAll('.hole-card').forEach(card => {
        card.addEventListener('click', () => {
            const holeNumber = card.dataset.hole;
            selectHole(holeNumber);
        });
    });
}

function selectHole(holeNumber) {
    // Deactivate the previously selected hole, if there was one
    if (selectedHole) {
        holeGrid.querySelector(`.hole-card[data-hole="${selectedHole}"]`)?.classList.remove('active');
        holeMarkers[selectedHole]?.getElement()?.classList.remove('active');
    }

    // If the same hole is clicked again, deselect it. Otherwise, select the new one.
    if (selectedHole === holeNumber) {
        stopMeasuring(); // Clean up measurement if active
        measureControl.getContainer().style.display = 'none';
        selectedHole = null;
        updateDistanceMessage();
        distanceDisplay.textContent = 'Select a Hole';
        if (distanceLine) map.removeLayer(distanceLine);
        return;
    }

    stopMeasuring(); // Stop any previous measurement
    selectedHole = holeNumber;

    // Activate the new hole
    holeGrid.querySelector(`.hole-card[data-hole="${holeNumber}"]`)?.classList.add('active');
    holeMarkers[holeNumber]?.getElement()?.classList.add('active');
    measureControl.getContainer().style.display = 'block'; // Show measure tool


            if (playerMarker) {
                updateDistanceLine();
                updateDistance();
            }

            updateDistanceMessage();
            
            if (window.innerWidth <= 768) {
                bottomPanel.classList.add('collapsed');
            }
        }

function updateDistanceLine() {
    if (!selectedHole || !playerMarker || !currentCourse) return;

    const hole = currentCourse.holes[selectedHole];
    const playerPos = playerMarker.getLatLng();

    if (distanceLine) {
        map.removeLayer(distanceLine);
    }

    distanceLine = L.polyline([
        [playerPos.lat, playerPos.lng],
        [hole.lat, hole.lon]
    ], {
        color: '#ff6e40',
        weight: 3,
        opacity: 0.8,
        dashArray: '10, 10'
    }).addTo(map);
}

function updateDistance() {
    if (!selectedHole || !playerMarker || !currentCourse) return;

    const hole = currentCourse.holes[selectedHole];
    const playerPos = playerMarker.getLatLng();

    const distanceInMeters = calculateDistance(
        playerPos.lat,
        playerPos.lng,
        hole.lat,
        hole.lon
    );

    const yards = Math.round(distanceInMeters * 1.09361);

    if (currentUnit === 'meters') {
        distanceDisplay.textContent = `${Math.round(yards * YARDS_TO_METERS)} meters`;
    } else {
        distanceDisplay.textContent = `${yards} yards`;
    }

    distanceMessage.textContent = `to hole ${selectedHole}`;
}

// --- Measurement Tool Functions ---

function toggleMeasurement(e) {
    if (e) e.preventDefault();
    if (!selectedHole) return;

    if (isMeasuring) {
        stopMeasuring();
    } else {
        startMeasuring();
    }
}

function startMeasuring() {
    if (!selectedHole || !currentCourse) return;
    isMeasuring = true;
    L.DomUtil.addClass(measureControl.getContainer(), 'active');

    const holePos = currentCourse.holes[selectedHole];

    const measureIcon = L.divIcon({
        className: 'measure-marker-icon',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    
    measureMarker = L.marker([holePos.lat, holePos.lon], { 
        draggable: true,
        icon: measureIcon 
    }).addTo(map);

    measureMarker.bindTooltip("drag me!", {
        permanent: true,
        direction: 'top',
        offset: [0, -15],
        className: 'distance-tooltip'
    }).openTooltip();

    measureMarker.on('dragstart', () => {
        if (measureMarker.getTooltip()) {
            measureMarker.closeTooltip();
            measureMarker.unbindTooltip();
        }
    });

    measureMarker.on('drag', updateMeasurementVisuals);
    
    // Create lines
    measureLineToHole = L.polyline([], { color: 'white', weight: 2, dashArray: '5, 5' }).addTo(map);
    measureLineToUser = L.polyline([], { color: '#f59e0b', weight: 2, dashArray: '5, 5' }).addTo(map);

    updateMeasurementVisuals();
}

function stopMeasuring() {
    isMeasuring = false;
    if (measureControl) L.DomUtil.removeClass(measureControl.getContainer(), 'active');

    if (measureMarker) { map.removeLayer(measureMarker); measureMarker = null; }
    if (measureLineToHole) { map.removeLayer(measureLineToHole); measureLineToHole = null; }
    if (measureLineToUser) { map.removeLayer(measureLineToUser); measureLineToUser = null; }
}

function updateMeasurementVisuals() {
    if (!isMeasuring || !measureMarker) return;
    
    const measurePos = measureMarker.getLatLng();
    const holePos = currentCourse.holes[selectedHole];
    
    // Update line to hole
    measureLineToHole.setLatLngs([[measurePos.lat, measurePos.lng], [holePos.lat, holePos.lon]]);
    updateDistanceTooltip(measureLineToHole, measurePos, holePos);

    // Update line to user
    if (playerMarker && lastPlayerPos) {
        if (!map.hasLayer(measureLineToUser)) {
            measureLineToUser.addTo(map);
        }
        const playerPos = playerMarker.getLatLng();
        measureLineToUser.setLatLngs([[measurePos.lat, measurePos.lng], [playerPos.lat, playerPos.lng]]);
        updateDistanceTooltip(measureLineToUser, measurePos, playerPos);
    } else if (map.hasLayer(measureLineToUser)) {
        map.removeLayer(measureLineToUser);
    }
}

function updateDistanceTooltip(line, posA, posB) {
    // Standardize longitude property, as Leaflet uses 'lng' and our data uses 'lon'
    const lonA = posA.lng ?? posA.lon;
    const lonB = posB.lng ?? posB.lon;

    // Safety check to prevent errors if coordinates are somehow invalid
    if (typeof posA.lat === 'undefined' || typeof lonA === 'undefined' || typeof posB.lat === 'undefined' || typeof lonB === 'undefined') {
        return;
    }

    const distanceMeters = calculateDistance(posA.lat, lonA, posB.lat, lonB);
    const yards = Math.round(distanceMeters * 1.09361);
    
    if (!line.getTooltip()) {
        line.bindTooltip('', { 
            permanent: true, 
            direction: 'center', 
            className: 'distance-tooltip',
            opacity: 0 // Start hidden
        });
    }
    const tooltip = line.getTooltip();

    if (yards < 1) {
        if(tooltip) tooltip.setOpacity(0);
    } else {
        let content;
        if (currentUnit === 'meters') {
            content = `${Math.round(yards * YARDS_TO_METERS)}m`;
        } else {
            content = `${yards}yd`;
        }

        // Calculate the midpoint for the tooltip
        const midLat = (posA.lat + posB.lat) / 2;
        const midLng = (lonA + lonB) / 2;
        const midPoint = L.latLng(midLat, midLng);

        if(tooltip) {
            tooltip.setOpacity(1);
            tooltip.setContent(content);
            tooltip.setLatLng(midPoint);
        }
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

function updateDistanceMessage() {
    if (!isTracking) {
        distanceMessage.textContent = 'Turn on to measure distances';
    } else if (!selectedHole) {
        distanceMessage.textContent = 'Tap a hole to measure distance';
    } else {
        distanceMessage.textContent = `to hole ${selectedHole}`;
    }
}

// Session persistence and auth state listener
async function restoreSession() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session && session.user) {
            currentUser = session.user;
        }
    } catch (err) {
        console.error('Error restoring session', err);
    } finally {
        // Listen to future auth changes so UI always reflects the right state
        supabaseClient.auth.onAuthStateChange((_event, session) => {
            currentUser = session?.user || null;
            updateUserInterface();
        });
    }
}

// Auth functions
function openAuthModal(mode) {
    authMode = mode;
    document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Sign Up';
    document.getElementById('authSubmit').textContent = mode === 'login' ? 'Login' : 'Sign Up';
    document.getElementById('authSwitch').textContent = mode === 'login' 
        ? "Don't have an account? Sign up"
        : "Already have an account? Login";
    
    clearAuthError();
    authModal.classList.add('active');
}

function closeAuthModal() {
    authModal.classList.remove('active');
    document.getElementById('authForm').reset();
    clearAuthError();
}

function switchAuthMode() {
    openAuthModal(authMode === 'login' ? 'signup' : 'login');
}

async function handleAuth(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const submitBtn = document.getElementById('authSubmit');
    
    clearAuthError();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Please wait...';
    
    try {
        let result;
        if (authMode === 'login') {
            result = await supabaseClient.auth.signInWithPassword({ email, password });
        } else {
            result = await supabaseClient.auth.signUp({ email, password });
        }
        
        if (result.error) throw result.error;
        
        if (authMode === 'signup') {
            showSuccess('Please check your email to confirm your account.');
        } else {
            currentUser = result.data.user;
            updateUserInterface();
            closeAuthModal();
            showSuccess('Successfully logged in!');
        }
        
    } catch (error) {
        showAuthError(error.message || 'Authentication failed');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = authMode === 'login' ? 'Login' : 'Sign Up';
    }
}

async function logout() {
    try {
        await supabaseClient.auth.signOut();
        
        currentUser = null;
        updateUserInterface();
        showSuccess('Logged out successfully');
    } catch (error) {
        showError('Logout failed');
    }
}

function updateUserInterface() {
            const loginBtn = document.getElementById('loginBtn');
            const dashboardBtn = document.getElementById('dashboardBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const sideMenuUser = document.getElementById('sideMenuUser');
            
            if (currentUser) {
                loginBtn.style.display = 'none';
                dashboardBtn.style.display = 'flex';
                logoutBtn.style.display = 'flex';
                
                sideMenuUser.textContent = currentUser.email;
                sideMenuUser.style.display = 'block';
            } else {
                loginBtn.style.display = 'flex';
                dashboardBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
                
                sideMenuUser.style.display = 'none';
            }
            
            populateDropdown();
        }

function openHelpModal() {
    helpModal.classList.add('active');
}

function closeHelpModal() {
    helpModal.classList.remove('active');
}

// Utility functions
function showError(message) {
    createToast(message, 'error');
}

function showSuccess(message) {
    createToast(message, 'success');
}

function createToast(message, type) {
    const toast = document.createElement('div');
    const bgColor = type === 'error' ? '#d32f2f' : 'var(--secondary-green)';
    
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        z-index: 10001;
        font-weight: 500;
        box-shadow: 0 4px 12px var(--shadow-strong);
        max-width: calc(100vw - 2rem);
        text-align: center;
        animation: slideInDown 0.3s ease;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutUp 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, type === 'error' ? 5000 : 3000);
}

function showAuthError(message) {
    const errorElement = document.getElementById('authError');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function clearAuthError() {
    const errorElement = document.getElementById('authError');
    errorElement.textContent = '';
    errorElement.style.display = 'none';
}

// Side menu controls
function openSideMenu() {
    sideMenu.classList.add('active');
    sideMenuOverlay.classList.add('active');
}

function closeSideMenu() {
    sideMenu.classList.remove('active');
    sideMenuOverlay.classList.remove('active');
    closeDropdown();
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideInDown {
        from {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutUp {
        from {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        to {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Initialize the app when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}

function startPanelDrag(e) {
    // Prevent page scroll on touch devices
    if (e.type === 'touchstart') {
        e.preventDefault();
    }
    
    isDraggingPanel = true;
    panelDragStartPos = e.touches ? e.touches[0].clientY : e.clientY;
    bottomPanel.classList.add('dragging');

    // Get the panel's current vertical position from its transform style
    const style = window.getComputedStyle(bottomPanel);
    const matrix = new DOMMatrixReadOnly(style.transform);
    initialPanelOffset = matrix.m42;

    document.addEventListener('mousemove', movePanelDrag);
    document.addEventListener('touchmove', movePanelDrag);
    document.addEventListener('mouseup', endPanelDrag);
    document.addEventListener('touchend', endPanelDrag);
}

function movePanelDrag(e) {
    if (!isDraggingPanel) return;

    const currentY = e.touches ? e.touches[0].clientY : e.clientY;
    const deltaY = currentY - panelDragStartPos;
    let newOffset = initialPanelOffset + deltaY;

    // Constrain the drag within the fully open and fully collapsed states
    const minOffset = 0; // Fully open
    const maxOffset = bottomPanel.offsetHeight - 120; // Fully collapsed
    newOffset = Math.max(minOffset, Math.min(newOffset, maxOffset));

    bottomPanel.style.transform = `translateY(${newOffset}px)`;
    currentPanelOffset = newOffset;
}

function endPanelDrag(e) {
    if (!isDraggingPanel) return;
    isDraggingPanel = false;

    bottomPanel.classList.remove('dragging');
    document.removeEventListener('mousemove', movePanelDrag);
    document.removeEventListener('touchmove', movePanelDrag);
    document.removeEventListener('mouseup', endPanelDrag);
    document.removeEventListener('touchend', endPanelDrag);
    
    const dragDistance = Math.abs((e.changedTouches ? e.changedTouches[0].clientY : e.clientY) - panelDragStartPos);

    // If the user moved their finger/mouse only a tiny bit, treat it as a click
    if (dragDistance < 10) {
        bottomPanel.classList.toggle('collapsed');
    } else {
        // Otherwise, it was a drag, so snap to the closest state
        const halfwayPoint = (bottomPanel.offsetHeight - 120) / 2;
        if (currentPanelOffset > halfwayPoint) {
            bottomPanel.classList.add('collapsed');
        } else {
            bottomPanel.classList.remove('collapsed');
        }
    }

    // Reset the inline style to allow the CSS classes and transitions to take over again
    bottomPanel.style.transform = '';
}
</script>
</body>
</html>